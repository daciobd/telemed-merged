<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fazer Pedido de Consulta ‚Äì TeleMed</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
      --primary:#0ea5e9; --primary-2:#0284c7; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --input:#0b1220; --border:#1e293b; --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      display:flex; align-items:flex-start; justify-content:center; padding:32px;
    }
    .card{
      width:min(680px,100%); background:var(--panel); border:1px solid var(--border);
      border-radius:var(--radius); padding:28px 26px 22px; box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    h1{margin:0 0 18px; font-size:28px; display:flex; align-items:center; gap:12px}
    .logo{width:24px;height:24px;display:inline-grid;place-items:center;background:#10b981;color:white;border-radius:8px;font-weight:700}
    p.muted{color:var(--muted); margin:0 0 16px}
    .grid{display:grid; gap:14px}
    @media(min-width:620px){ .grid-2{grid-template-columns:1fr 1fr} }
    label{display:block; margin:8px 2px 6px; color:#cbd5e1; font-size:13px}
    input, textarea, select{
      width:100%; background:var(--input); color:var(--text);
      border:1px solid var(--border); border-radius:12px; padding:12px 14px;
      outline:none; transition:.15s border, .15s box-shadow; font-size:15px;
    }
    input:focus, textarea:focus, select:focus{
      border-color:var(--primary); box-shadow:0 0 0 4px rgb(14 165 233 / .15);
    }
    input:disabled{background:#071326; color:var(--muted); cursor:not-allowed}
    .row{display:flex; flex-wrap:wrap; gap:10px; margin-top:18px}
    .row .spacer{flex:1}
    .btn{
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      color:var(--text); background:#0b1530; cursor:pointer; font-weight:600;
      text-decoration:none; display:inline-block; text-align:center;
    }
    .btn:hover{filter:brightness(1.08)}
    .btn.primary{background:linear-gradient(180deg, var(--primary), var(--primary-2)); border-color:#065f92; color:#fff}
    .btn.outline{background:transparent; color:var(--primary); border-color:var(--primary)}
    .info-box{margin:16px 0; padding:14px; border-radius:12px; background:#0e2720; border:1px solid #1a3e33; color:#79f2a6}
    .checkbox-group{display:flex; align-items:center; gap:8px; margin:8px 0}
    .checkbox-group input[type="checkbox"]{width:auto}
  </style>
</head>
<body>
  <main class="card">
    <h1><span class="logo">ü©∫</span> Fazer Pedido de Consulta</h1>
    
    <p class="muted">
      Configure os detalhes da sua consulta. O sistema criar√° um lance (BID) que ser√° processado pelos m√©dicos dispon√≠veis.
    </p>

    <form id="bid-form" class="grid">
      <div>
        <label for="patientId">Patient ID</label>
        <input id="patientId" name="patientId" type="text" placeholder="ID ser√° preenchido automaticamente do seu cadastro" readonly data-testid="input-patient-id" />
      </div>

      <div class="grid grid-2">
        <div>
          <label for="specialty">Especialidade</label>
          <select id="specialty" name="specialty" data-testid="select-specialty">
            <option value="clinica_geral">Cl√≠nica Geral</option>
            <option value="cardiologia">Cardiologia</option>
            <option value="dermatologia">Dermatologia</option>
            <option value="ginecologia">Ginecologia</option>
            <option value="neurologia">Neurologia</option>
            <option value="pediatria">Pediatria</option>
            <option value="psiquiatria">Psiquiatria</option>
            <option value="ortopedia">Ortopedia</option>
          </select>
        </div>

        <div>
          <label for="amount">Valor m√°ximo (R$)</label>
          <input id="amount" name="amount" type="number" min="50" max="500" step="10" value="120" data-testid="input-amount" />
        </div>
      </div>

      <div class="checkbox-group" id="priority-group" style="display:none;">
        <input id="priority" name="priority" type="checkbox" data-testid="checkbox-priority" />
        <label for="priority">Atendimento priorit√°rio (+R$ 30) ‚Äî m√©dicos respondem mais r√°pido</label>
      </div>

      <div id="price-hint" style="color:#79f2a6; font-size:13px; margin:4px 0;"></div>

      <div class="checkbox-group">
        <input id="immediate" name="immediate" type="checkbox" checked data-testid="checkbox-immediate" />
        <label for="immediate">Consulta imediata (assim que poss√≠vel)</label>
      </div>

      <div id="scheduled-section" style="display:none">
        <label for="slot">Hor√°rio preferido</label>
        <input id="slot" name="slot" type="datetime-local" data-testid="input-slot" />
      </div>

      <div class="info-box" id="bid-info">
        <strong>Como funciona:</strong> Seu pedido ser√° enviado como um lance (BID) para m√©dicos da especialidade selecionada. 
        Quando um m√©dico aceitar, voc√™ receber√° uma notifica√ß√£o e poder√° prosseguir para o pagamento.
      </div>

      <div class="row" style="grid-column:1/-1">
        <button type="submit" class="btn primary" data-testid="button-submit-bid">Enviar Pedido</button>
        <button type="button" class="btn outline" id="btn-back" data-testid="button-back">Voltar</button>
        <span class="spacer"></span>
        <a href="/sala-de-espera.html" class="btn" data-testid="link-waiting-room">Sala de Espera</a>
      </div>
    </form>
  </main>

  <script>
    // Pr√©-preencher patientId conforme patch 2
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get('patientId') || localStorage.getItem('patientId') || '';
    
    const patientIdEl = document.getElementById('patientId');
    if (patientIdEl) patientIdEl.value = patientId;

    // Toggle de consulta imediata/agendada
    const immediateEl = document.getElementById('immediate');
    const scheduledSection = document.getElementById('scheduled-section');
    
    immediateEl.addEventListener('change', () => {
      scheduledSection.style.display = immediateEl.checked ? 'none' : 'block';
    });

    // Bot√£o voltar
    document.getElementById('btn-back').addEventListener('click', () => {
      window.history.back();
    });

    // Submit do formul√°rio
    document.getElementById('bid-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const data = {
        patientId: formData.get('patientId'),
        specialty: formData.get('specialty'),
        amountCents: Math.round(parseFloat(formData.get('amount')) * 100),
        mode: formData.get('immediate') ? 'immediate' : 'scheduled',
        proposedSlot: formData.get('immediate') ? undefined : formData.get('slot')
      };

      if (!data.patientId) {
        alert('Patient ID √© obrigat√≥rio. Por favor, volte e complete o cadastro.');
        return;
      }

      try {
        // Modo DEMO: Simula cria√ß√£o de BID bem-sucedida localmente
        const bidId = 'bid_' + Date.now();
        const appointmentId = 'appt_' + Date.now();
        
        // Simula resultado bem-sucedido
        const result = {
          ok: true,
          bid: {
            id: bidId,
            patientId: data.patientId,
            specialty: data.specialty,
            amountCents: data.amountCents,
            status: 'pending',
            createdAt: new Date().toISOString()
          },
          appointmentId: appointmentId
        };
        
        // Salvar resultado localmente para demo
        localStorage.setItem('lastBid', JSON.stringify(result));
        localStorage.setItem(`bid:${bidId}`, JSON.stringify(result.bid));
        
        console.log('‚úÖ BID criado com sucesso (modo demo):', result);
        
        // Redirecionar para sala de espera com os IDs gerados
        alert('‚úÖ Pedido enviado com sucesso! Redirecionando para sala de espera...');
        window.location.href = `/sala-de-espera.html?appointmentId=${appointmentId}&patientId=${data.patientId}`;
        
      } catch (error) {
        console.error('Erro ao processar BID:', error);
        alert('Erro interno. Tente novamente em alguns segundos.');
      }
    });
  </script>

  <!-- A/B Experiment Loader: offer_ui_v1 -->
  <script>
  (function () {
    const EXP_ENDPOINT = "/api/experiments/active";
    const EXP_ID = "offer_ui_v1";
    const STORE_KEY = "exp:" + EXP_ID;

    const FALLBACK_EXP = {
      id: EXP_ID,
      isActive: true,
      trafficPercent: 100,
      variants: [{ name: "A", weight: 50 }, { name: "B", weight: 50 }],
    };

    function hashToInt(str) {
      let h = 2166136261;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h += (h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24);
      }
      return (h >>> 0);
    }

    function getSessionIdSafe() {
      if (window.TelemedTelemetry?.sessionId) return window.TelemedTelemetry.sessionId();
      const k = "telemed_session_id";
      let sid = localStorage.getItem(k);
      if (!sid) {
        sid = "sess-" + (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2));
        localStorage.setItem(k, sid);
      }
      return sid;
    }

    function pickVariant(sessionId, exp) {
      if (!exp?.isActive) return "A";
      const bucket100 = hashToInt(sessionId + "|" + exp.id + "|traffic") % 100;
      const traffic = Math.max(0, Math.min(100, parseInt(exp.trafficPercent ?? 100, 10) || 100));
      if (bucket100 >= traffic) return "A";

      const variants = Array.isArray(exp.variants) && exp.variants.length ? exp.variants : FALLBACK_EXP.variants;
      const total = variants.reduce((s, v) => s + (parseInt(v.weight, 10) || 0), 0) || 1;
      const bucket = hashToInt(sessionId + "|" + exp.id) % 10000;
      let acc = 0;
      for (const v of variants) {
        acc += Math.round(((parseInt(v.weight, 10) || 0) / total) * 10000);
        if (bucket < acc) return v.name;
      }
      return variants[0].name;
    }

    async function loadExp() {
      try {
        const res = await fetch(EXP_ENDPOINT, { credentials: "include" });
        const json = await res.json();
        return (json?.experiments || []).find(e => e.id === EXP_ID) || FALLBACK_EXP;
      } catch {
        return FALLBACK_EXP;
      }
    }

    async function getOfferVariant() {
      const stored = localStorage.getItem(STORE_KEY);
      if (stored) return stored;

      const exp = await loadExp();
      const variant = pickVariant(getSessionIdSafe(), exp);
      localStorage.setItem(STORE_KEY, variant);
      return variant;
    }

    window.TelemedExperiments = window.TelemedExperiments || {};
    window.TelemedExperiments.getOfferVariant = getOfferVariant;

    // Apply variant on load
    (async function () {
      const variant = await getOfferVariant();
      const amountInput = document.getElementById("amount");
      const infoBox = document.getElementById("bid-info");
      const submitBtn = document.querySelector('button[type="submit"]');

      const experimentsPayload = { offer_ui_v1: variant };

      function trackView() {
        window.TelemedTelemetry?.track?.("offer_view", { experiments: experimentsPayload });
      }

      function trackOfferCreated(price) {
        window.TelemedTelemetry?.track?.("offer_created", {
          offeredPrice: price,
          experiments: experimentsPayload,
        });
      }

      // Variant A: Campo livre + exemplo (control)
      if (variant === "A") {
        if (infoBox) {
          infoBox.innerHTML = "<strong>Dica:</strong> Valores entre R$ 100 e R$ 200 costumam ser aceitos mais r√°pido. Voc√™ pode sugerir um valor.";
        }
      }

      // Variant B: Default sugerido + bot√µes r√°pidos
      if (variant === "B") {
        if (amountInput && !amountInput.dataset.touched) amountInput.value = "180";
        if (infoBox) {
          infoBox.innerHTML = "<strong>Sugest√£o r√°pida:</strong> Escolha um valor ou ajuste conforme preferir.";
          
          // Create quick buttons
          const btnContainer = document.createElement("div");
          btnContainer.style.cssText = "display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;";
          const values = [120, 150, 180, 220];
          values.forEach(v => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.textContent = `R$ ${v}`;
            btn.style.cssText = "padding:8px 12px;border:1px solid #1a3e33;border-radius:10px;background:#0b1530;color:#79f2a6;cursor:pointer;font-weight:600;";
            btn.addEventListener("click", () => {
              if (amountInput) amountInput.value = String(v);
            });
            btnContainer.appendChild(btn);
          });
          infoBox.appendChild(btnContainer);
        }
      }

      // Track de envio
      if (submitBtn) {
        submitBtn.addEventListener("click", () => {
          const price = amountInput ? Number(String(amountInput.value).replace(",", ".")) : null;
          trackOfferCreated(price);
        });
      }

      trackView();
    })();
  })();
  </script>

  <!-- A/B Experiment Loader: price_anchor_v1 -->
  <script>
  (function () {
    const EXP_ENDPOINT = "/api/experiments/active";
    const EXP_ID = "price_anchor_v1";
    const STORE_KEY = "exp:" + EXP_ID;

    const FALLBACK_EXP = {
      id: EXP_ID,
      isActive: true,
      trafficPercent: 100,
      variants: [{ name: "A", weight: 50 }, { name: "B", weight: 50 }],
    };

    function hashToInt(str) {
      let h = 2166136261;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h += (h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24);
      }
      return (h >>> 0);
    }

    function getSessionIdSafe() {
      if (window.TelemedTelemetry?.sessionId) return window.TelemedTelemetry.sessionId();
      const k = "telemed_session_id";
      let sid = localStorage.getItem(k);
      if (!sid) {
        sid = "sess-" + (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2));
        localStorage.setItem(k, sid);
      }
      return sid;
    }

    function pickVariant(sessionId, exp) {
      if (!exp?.isActive) return "A";
      const bucket100 = hashToInt(sessionId + "|" + exp.id + "|traffic") % 100;
      const traffic = Math.max(0, Math.min(100, parseInt(exp.trafficPercent ?? 100, 10) || 100));
      if (bucket100 >= traffic) return "A";

      const variants = Array.isArray(exp.variants) && exp.variants.length ? exp.variants : FALLBACK_EXP.variants;
      const total = variants.reduce((s, v) => s + (parseInt(v.weight, 10) || 0), 0) || 1;
      const bucket = hashToInt(sessionId + "|" + exp.id) % 10000;
      let acc = 0;
      for (const v of variants) {
        acc += Math.round(((parseInt(v.weight, 10) || 0) / total) * 10000);
        if (bucket < acc) return v.name;
      }
      return variants[0].name;
    }

    async function loadExp() {
      try {
        const res = await fetch(EXP_ENDPOINT, { credentials: "include" });
        const json = await res.json();
        return (json?.experiments || []).find(e => e.id === EXP_ID) || FALLBACK_EXP;
      } catch {
        return FALLBACK_EXP;
      }
    }

    async function getPriceVariant() {
      const stored = localStorage.getItem(STORE_KEY);
      if (stored) return stored;
      const exp = await loadExp();
      const variant = pickVariant(getSessionIdSafe(), exp);
      localStorage.setItem(STORE_KEY, variant);
      return variant;
    }

    window.TelemedExperiments = window.TelemedExperiments || {};
    window.TelemedExperiments.getPriceVariant = getPriceVariant;

    // Apply price anchor variant
    (async function () {
      const variant = await getPriceVariant();
      const experimentsPayload = { price_anchor_v1: variant };

      const priceInput = document.getElementById("amount");
      const priorityGroup = document.getElementById("priority-group");
      const priorityChk = document.getElementById("priority");
      const hint = document.getElementById("price-hint");
      const submitBtn = document.querySelector('button[type="submit"]');

      // Variant A: sugest√£o R$ 200 (controle)
      if (variant === "A") {
        if (priceInput && !priceInput.dataset.touched) priceInput.value = "200";
        if (priorityChk) priorityChk.checked = false;
        if (hint) hint.textContent = "Valor sugerido para atendimento padr√£o.";
      }

      // Variant B: √¢ncora R$ 250 + prioridade habilitada
      if (variant === "B") {
        if (priceInput && !priceInput.dataset.touched) priceInput.value = "250";
        if (priorityGroup) priorityGroup.style.display = "flex";
        if (priorityChk) priorityChk.checked = true;
        if (hint) hint.textContent = "Sugest√£o para atendimento mais r√°pido (prioridade).";
      }

      // Track visualiza√ß√£o da √¢ncora
      window.TelemedTelemetry?.track?.("price_view", {
        experiments: experimentsPayload,
        suggestedPrice: Number(priceInput?.value || 0),
        priorityDefault: !!priorityChk?.checked,
      });

      // Track envio de oferta com pre√ßo final
      if (submitBtn) {
        submitBtn.addEventListener("click", () => {
          const base = Number(String(priceInput?.value || 0).replace(",", "."));
          const priorityFee = priorityChk?.checked ? 30 : 0;
          const finalPrice = base + priorityFee;

          window.TelemedTelemetry?.track?.("price_submitted", {
            offeredPrice: finalPrice,
            basePrice: base,
            priority: !!priorityChk?.checked,
            experiments: experimentsPayload,
          });
        });
      }
    })();
  })();
  </script>
</body>
</html>