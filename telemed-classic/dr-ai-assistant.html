<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistente Telemed ‚Äî Dr. AI</title>
  <script>window.__BUILD='pilot-r1';</script>
  <style>
    :root{ --bg:#0b1220; --panel:#0f172a; --muted:#94a3b8; --text:#e2e8f0; --brand:#60a5fa; --border:rgba(148,163,184,.22); --ok:#34d399; --warn:#fbbf24; --danger:#ef4444 }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";background:#f3f4f6;color:#111827}

    /* ===== Layout raiz 3‚Üí2‚Üí1 colunas ===== */
    #dr-ai-root{display:grid;grid-template-columns:clamp(260px,26vw,360px) 1fr clamp(280px,28vw,380px);gap:16px;align-items:start;max-width:1280px;margin:0 auto;padding:16px}
    @media (max-width: 1024px){ #dr-ai-root{grid-template-columns: clamp(260px,42vw,380px) 1fr} }
    @media (max-width: 640px){ #dr-ai-root{grid-template-columns: 1fr} }

    /* ===== Coluna esquerda (cart√£o paciente/consulta) ===== */
    .left-card{background:#2563eb;color:white;border-radius:14px;padding:18px;position:sticky;top:12px}
    .left-card h1{font-size:30px;line-height:1.1;margin:0 0 8px}
    .left-card .muted{opacity:.9}
    .row{display:flex;gap:10px;flex-wrap:wrap}

    /* ===== Coluna do meio (thread) ===== */
    #drai-thread{background:#fff;border:1px solid #e5e7eb;border-radius:12px;min-height:280px;max-height:calc(100vh - 220px);overflow:auto;padding:12px}
    .bubble{margin:8px 0;display:flex}
    .bubble .msg{max-width:85%;padding:10px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.25)}
    .bubble.you{justify-content:flex-start}
    .bubble.you .msg{background:#ffffff;color:#111827}
    .bubble.ai{justify-content:flex-start}
    .bubble.ai .msg{background:#0f172a;color:#e2e8f0}

    /* ===== Coluna direita (input/chat + estado) ===== */
    .right{display:grid;gap:10px;align-content:start}
    .chat-input{display:flex;gap:8px;align-items:center}
    .chat-input input{flex:1;border:1px solid #cbd5e1;border-radius:999px;padding:10px 14px}
    .send{border:0;background:#2563eb;color:#fff;width:44px;height:44px;border-radius:999px;cursor:pointer;font-weight:800}
    #emergency-banner{display:none;border:1px solid #ef4444;background:#fee2e2;color:#991b1b;border-radius:8px;padding:6px 10px;font-weight:700}
    .faq{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
    .faq h3{margin:0 0 6px}
    .faq a{display:inline-block;margin:6px 6px 0 0;padding:6px 8px;border:1px solid #cbd5e1;border-radius:8px;text-decoration:none;color:#1f2937;background:#f8fafc}
    .faq a:hover{background:#f1f5f9}

    /* util */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <main id="dr-ai-root">
    <!-- ESQUERDA -->
    <aside class="left-card" aria-label="Dados da consulta">
      <h1>Assistente Telemed</h1>
      <p class="muted">Tire d√∫vidas sobre suas orienta√ß√µes</p>
      <div class="row" style="margin-top:12px">
        <div>
          <div><strong>üë®‚Äç‚öïÔ∏è Dr. Roberto Silva</strong></div>
          <div>Cardiologia</div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div>‚óå √öltima: <strong>25/09/2025</strong></div>
        <div>‚óå Pr√≥xima: <strong>25/10/2025</strong></div>
      </div>
    </aside>

    <!-- MEIO (thread) -->
    <section>
      <div id="drai-thread" aria-live="polite" aria-atomic="false">
        <div class="bubble ai"><div class="msg"><strong>Dr. AI</strong><br> Sintomas novos? Clique em <em>Falar com M√©dico</em>. Para d√∫vidas sobre a consulta, escreva √† direita.</div></div>
      </div>
    </section>

    <!-- DIREITA (entrada) -->
    <section class="right">
      <form id="drai-form" class="chat-input" autocomplete="off">
        <label for="drai-input" class="sr-only">Digite sua d√∫vida</label>
        <input id="drai-input" placeholder="Digite sua d√∫vida..." />
        <button id="drai-send" class="send" type="submit" title="Enviar">‚û§</button>
      </form>
      <div id="emergency-banner">‚ö†Ô∏è Preciso de atendimento m√©dico</div>

      <div class="faq" id="drai-faq" aria-label="Perguntas frequentes">
        <h3>Perguntas frequentes:</h3>
        <a href="?q=Como%20tomar%20meu%20medicamento%3F">Como tomar meu medicamento?</a>
        <a href="?q=Posso%20fazer%20exerc%C3%ADcios%3F">Posso fazer exerc√≠cios?</a>
        <a href="?q=Quando%20devo%20retornar%3F">Quando devo retornar?</a>
        <a href="?q=O%20que%20significa%20meu%20diagn%C3%B3stico%3F">O que significa meu diagn√≥stico?</a>
      </div>
    </section>
  </main>

  <script>
  (function(){
    const thread = document.getElementById('drai-thread');
    const form   = document.getElementById('drai-form');
    const input  = document.getElementById('drai-input');
    const sendBtn= document.getElementById('drai-send');
    const faq    = document.getElementById('drai-faq');
    const banner = document.getElementById('emergency-banner');

    function bubble(who, text){
      const box = document.createElement('div'); box.className = 'bubble ' + (who==='AI'?'ai':'you');
      const msg = document.createElement('div'); msg.className = 'msg';
      msg.innerHTML = (who==='AI'?'<strong>Dr. AI</strong><br>':'<strong>Voc√™</strong><br>') + escapeHtml(text).replace(/\n/g,'<br>');
      box.appendChild(msg); thread.appendChild(box); scrollBottom();
    }
    function scrollBottom(){ thread.scrollTo({ top: thread.scrollHeight, behavior:'smooth' }); }
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    async function ask(question){
      if(!question) return; bubble('YOU', question);
      try {
        const r = await fetch('/api/ai/answer', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ question, channel:'web', locale:'pt-BR' }) });
        const data = await r.json();
        handle(data);
      } catch(e){
        handle(mockAI(question));
      }
    }

    function handle(data){
      const tipo = (data && data.tipo) || 'esclarecimento';
      const msg  = (data && (data.mensagem||data.message)) || '‚Äî';
      if (tipo === 'escala_emergencia') { banner.style.display='block'; input.disabled = true; }
      else { banner.style.display='none'; input.disabled = false; }
      bubble('AI', msg);
    }

    // Fallback simple policy
    function mockAI(q){
      const s = q.normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
      if(/dor no peito|falta de ar|desmaio|sangramento|convulsao/.test(s)){
        return { tipo:'escala_emergencia', mensagem:'‚ö†Ô∏è Sinais de urg√™ncia. Procure atendimento imediato (192/UPA).', metadados:{} };
      }
      if(/trocar|aumentar|diminuir|mudar.*dose|prescrever|receitar|antibiotico novo|remedio novo/.test(s)){
        return { tipo:'fora_escopo', mensagem:'Este pedido exige avalia√ß√£o m√©dica. Posso encaminhar para agendar uma consulta.', metadados:{} };
      }
      if(/alcool|bebida/.test(s)){
        return { tipo:'esclarecimento', mensagem:'Como regra geral, evite √°lcool durante o uso do medicamento salvo orienta√ß√£o do seu m√©dico. Pode aumentar efeitos adversos e reduzir efic√°cia.', metadados:{} };
      }
      return { tipo:'esclarecimento', mensagem:'Posso ajudar com orienta√ß√µes baseadas na sua consulta. Se surgirem sintomas novos ou piora, procure seu m√©dico.', metadados:{} };
    }

    // Envio
    form.addEventListener('submit', (e)=>{ e.preventDefault(); const q = input.value.trim(); if(!q) return input.focus(); ask(q); input.value=''; input.focus({preventScroll:true}); });
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); form.requestSubmit(); } });

    // Intercepta cliques das FAQs para enviar sem recarregar
    faq.addEventListener('click', (e)=>{
      const a = e.target.closest('a'); if(!a) return; e.preventDefault(); const q = decodeURIComponent(a.search.replace(/^\?q=/,'')); input.value = q; ask(q); history.replaceState({}, '', location.pathname); });

    // Deep link: ?q=...
    const qparam = new URLSearchParams(location.search).get('q');
    if (qparam) { input.value = qparam; setTimeout(()=>{ ask(qparam); history.replaceState({}, '', location.pathname); }, 60); }

    new ResizeObserver(scrollBottom).observe(thread);
  })();
  </script>

  <!-- Dr. AI Integration Widget -->
  <script src="/js/dr-ai-integration.js" defer></script>
</body>
</html>
