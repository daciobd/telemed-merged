<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TeleMed ‚Äî Demo para M√©dicos</title>
  <meta name="telemed-no-guard" content="1" />
  <style>
    :root{
      --brand:#0ea5e9; --ink:#0b1324; --ok:#059669; --bad:#dc2626;
      --text:#111827; --muted:#6b7280; --card:#fff; --border:#e5e7eb; --bg:#f8fafc;
    }
    *{box-sizing:border-box} body{margin:0;padding:24px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}
    .hero{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
    .hero h1{margin:0}
    .hero .tag{background:var(--brand);color:#fff;padding:6px 10px;border-radius:999px;font-size:.85rem}
    .links a{margin-right:8px;color:var(--brand);text-decoration:none;border-bottom:1px dashed var(--brand)}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .muted{color:var(--muted)}
    .btn{background:var(--brand);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input,select,textarea{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    label{display:block;font-size:.9rem;margin:6px 0 4px}
    pre{background:#0b1020;color:#e5e7eb;padding:12px;border-radius:10px;overflow:auto;font-size:12px}
    .row{display:flex;gap:8px;align-items:center}.row>*{flex:1}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .presenter{position:fixed;right:16px;bottom:16px;z-index:50;background:var(--ink);color:#e5e7eb;border-radius:12px;padding:12px 14px;box-shadow:0 10px 25px rgba(0,0,0,.25);width:320px;max-height:60vh;overflow:auto;display:none}
    .presenter h3{margin:8px 0 6px;font-size:14px}.presenter p,.presenter li{font-size:12px;color:#cbd5e1}.presenter .close{position:absolute;top:6px;right:10px;cursor:pointer}
    .presenter-toggle{position:fixed;right:16px;bottom:16px;z-index:51}
    .card.success{background:#f0f9ff;border-color:#0ea5e9}
    .card.success h4{margin:0 0 10px;color:#0369a1}
    .card.success ol, .card.success ul{margin:0;padding-left:20px}
    .card.success a{color:#0ea5e9;text-decoration:none}
    .card.success a:hover{text-decoration:underline}
    .card.success code{background:#e0f2fe;color:#0369a1;padding:2px 4px;border-radius:4px}
  </style>
</head>
<body>
  <header class="hero">
    <span class="tag">TeleMed</span>
    <h1>Demo para M√©dicos</h1>
    <div class="links">
      <a href="/index.html">Home</a>
      <a href="/example-integration.html">Exemplo simples</a>
    </div>
    <button class="btn presenter-toggle" onclick="togglePresenter()">Roteiro</button>
  </header>

  <section class="card">
    <h2>0) Pre-Flight / Healthchecks</h2>
    <p class="muted">Configure os endpoints e verifique <code>/healthz</code>.</p>
    <div class="grid">
      <div>
        <label>AUCTION_URL</label>
        <input id="auUrl" placeholder="https://telemed-auction.onrender.com" />
        <button class="btn" id="checkAuction">Testar Auction</button>
        <div id="outAuction"></div>
      </div>
      <div>
        <label>INTERNAL_URL</label>
        <input id="inUrl" placeholder="https://telemed-internal.onrender.com" />
        <button class="btn" id="checkInternal">Testar Internal</button>
        <div id="outInternal"></div>
      </div>
      <div>
        <label>PRODUCTIVITY_URL</label>
        <input id="prodUrl" placeholder="https://telemed-productivity.onrender.com" />
        <button class="btn" id="checkProd">Testar Productivity</button>
        <div id="outProd"></div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>1) Leil√£o Reverso ‚Äî Criar BID</h2>
    <div class="grid">
      <div>
        <label>patientId</label>
        <input id="patientId" value="paciente-demo" />
        <label for="specialty">Especialidade desejada</label>
        <select id="specialty" name="specialty">
          <option value="">Selecione‚Ä¶</option>
          <option>Cl√≠nica Geral</option>
          <option>Cardiologia</option>
          <option>Dermatologia</option>
          <option>Endocrinologia</option>
          <option>Gastroenterologia</option>
          <option>Geriatria</option>
          <option>Ginecologia</option>
          <option>Infectologia</option>
          <option>Neurologia</option>
          <option>Oftalmologia</option>
          <option>Ortopedia</option>
          <option>Otorrinolaringologia</option>
          <option>Pediatria</option>
          <option>Psiquiatria</option>
          <option>Reumatologia</option>
          <option>Urologia</option>
        </select>
        <label>isImmediate</label>
        <select id="isImmediate">
          <option value="true" selected>true</option>
          <option value="false">false</option>
        </select>
        <label>amountCents</label>
        <input id="amountCents" type="number" value="9000" />
        <button class="btn" id="btnCreateBid">Criar BID (seed)</button>
        <div id="outCreateBid" class="muted"></div>
      </div>
      <div>
        <label>Bid ID (preenchido ap√≥s criar)</label>
        <input id="bidId" />
        <label>Modo</label>
        <select id="mode">
          <option value="immediate" selected>immediate</option>
          <option value="scheduled">scheduled</option>
        </select>
        <label>scheduledFor (ISO)</label>
        <input id="scheduledFor" placeholder="2025-09-04T14:00:00Z" />
        <button class="btn" id="btnAcceptBid">Aceitar BID ‚Üí criar consulta</button>
        <div id="outAcceptBid" class="muted"></div>
      </div>
    </div>
  </section>

  <!-- Pr√≥ximos passos -->
  <div id="next-steps" class="card" style="margin-top:16px;padding:16px;border:1px solid #0ea5e9;background:#eef7ff">
    <h4 style="margin:0 0 8px">Pr√≥ximos passos</h4>
    <ol style="margin:0;padding-left:18px">
      <li>Aguarde criar/aceitar o BID‚Ä¶</li>
      <li>Opcional: <a target="_blank" href="/example-integration.html#scribe">Abrir Scribe/CIDs</a></li>
      <li><a href="/index.html">Voltar ao Hub</a></li>
    </ol>
  </div>

  <section class="card">
    <h2>2) Atalhos</h2>
    <div class="grid">
      <a class="btn" target="_blank" id="openAuction">Abrir Auction</a>
      <a class="btn" target="_blank" id="openProd">Abrir Productivity</a>
    </div>
  </section>

  <section class="card">
    <h2>Logs</h2>
    <pre id="log"></pre>
  </section>

  <div class="presenter" id="presenter">
    <span class="close" onclick="togglePresenter()">‚úñ</span>
    <h3>Roteiro R√°pido (15‚Äì20 min)</h3>
    <ol>
      <li>Health: Auction + Internal + Productivity ‚Üí OK</li>
      <li>Criar BID (seed) ‚Üí copiar <em>Bid ID</em></li>
      <li>Aceitar BID (immediate) ‚Üí mostrar <code>appointment</code></li>
      <li>Explicar prontu√°rio/IA (Productivity) na demo verbal (link "Abrir Productivity").</li>
    </ol>
    <h3>Mensagens-chave</h3>
    <ul>
      <li>Suporte √† decis√£o; m√©dico no comando.</li>
      <li>Padroniza√ß√£o e agilidade.</li>
      <li>Integra√ß√£o ponta-a-ponta (lance ‚Üí consulta).</li>
    </ul>
  </div>

  <script>
    function togglePresenter(){
      const x=document.getElementById('presenter');
      x.style.display = (x.style.display==='none'||!x.style.display)?'block':'none';
    }

    const logEl = document.getElementById('log');
    function log(msg, obj){
      const line = '['+new Date().toISOString()+'] '+msg+'\n';
      logEl.textContent += line + (obj? JSON.stringify(obj,null,2)+'\n' : '');
      logEl.scrollTop = logEl.scrollHeight;
    }

    const AU = document.getElementById('auUrl');
    const IN = document.getElementById('inUrl');
    const PR = document.getElementById('prodUrl');

    // Sugest√£o: preencher automaticamente se j√° sabe as URLs
    AU.value = 'https://telemed-auction.onrender.com';
    IN.value = 'https://telemed-internal.onrender.com';
    PR.value = 'https://telemed-productivity.onrender.com';
    document.getElementById('openAuction').href = AU.value;
    document.getElementById('openProd').href    = PR.value;

    async function health(url, outId){
      const out = document.getElementById(outId);
      out.innerHTML = 'Testando...';
      if(!url){ out.innerHTML='<span class="bad">URL vazia</span>';return; }
      
      // Detectar qual servi√ßo e usar proxy para evitar CORS
      let service = '';
      if(url.includes('auction')) service = 'auction';
      else if(url.includes('productivity')) service = 'productivity';  
      else if(url.includes('internal')) service = 'internal';
      
      try{
        let r;
        if(service) {
          // Usar proxy local para evitar CORS
          r = await fetch(`/proxy/health/${service}`, { mode: 'cors' });
        } else {
          // Fallback direto
          r = await fetch(url.replace(/\/$/,'') + '/healthz', { mode: 'cors' });
        }
        
        const txt = await r.text().catch(() => '');
        out.innerHTML = r.ok ? '<span class="ok">OK</span>' : `<span class="bad">Falha ${r.status}</span>`;
        log('health '+url, { status: r.status, response: txt });
      }catch(e){
        out.innerHTML = '<span class="bad">erro: '+String(e).substring(0,50)+'</span>';
        log('health '+url+' erro', {error:String(e)});
      }
    }
    document.getElementById('checkAuction').onclick = ()=>health(AU.value,'outAuction');
    document.getElementById('checkInternal').onclick= ()=>health(IN.value,'outInternal');
    document.getElementById('checkProd').onclick    = ()=>health(PR.value,'outProd');

    // --- MOSTRAR OS LINKS AUTOMATICAMENTE ---
    const $next = document.getElementById('next-steps');

    function showNextSteps({ bidId, appointmentId }) {
      const room = String(appointmentId || bidId || 'telemed-demo');
      const waitUrl  = `/sala-de-espera.html?appointmentId=${encodeURIComponent(room)}`;
      const consultaUrlDoctor = `/consulta/?appointmentId=${encodeURIComponent(room)}&role=doctor`;

      $next.innerHTML = `
        <h4 style="margin:0 0 8px">Pr√≥ximos passos</h4>
        <ol style="margin:0;padding-left:18px">
          ${bidId ? `<li>Bid criado: <code>${bidId}</code>.</li>` : ''}
          ${appointmentId
            ? `<li>Consulta criada: <code>${appointmentId}</code></li>`
            : bidId
              ? `<li><em>Usando o Bid ID como sala provis√≥ria.</em></li>`
              : `<li>Crie um BID para habilitar os links.</li>`
          }
          <li>Paciente: abrir a <a target="_blank" href="${waitUrl}">Sala de Espera</a>.</li>
          <li>M√©dico: entrar na <a target="_blank" href="${consultaUrlDoctor}">Sala de V√≠deo</a>.</li>
          <li>Opcional: <a target="_blank" href="/example-integration.html#scribe">Abrir Scribe/CIDs</a></li>
          <li><a href="/index.html">Voltar ao Hub</a></li>
        </ol>`;
    }

    // j√° atualiza quando o BID √© criado
    window.onBidCreated = (res) => showNextSteps({ bidId: res?.bidId });

    // atualiza quando a consulta √© criada (aceitar BID)
    window.onBidAccepted = (res) => showNextSteps({ bidId: res?.bidId, appointmentId: res?.appointmentId });

    // watchdog: se alguma chamada de rede retornar {appointmentId}, atualiza sozinho
    (function hookNetwork() {
      const bump = (data) => {
        if (!data || typeof data !== 'object') return;
        const appointmentId = data.appointmentId || data.consultaId || data.appointment?.id || data.consulta?.id;
        const bidId = data.bidId || data.bid_id || data.bid?.id;
        if (appointmentId) showNextSteps({ bidId, appointmentId });
      };

      // fetch
      const _fetch = window.fetch;
      window.fetch = async (...args) => {
        const res = await _fetch(...args);
        try { bump(await res.clone().json().catch(() => null)); } catch {}
        return res;
      };

      // XHR
      const _open = XMLHttpRequest.prototype.open;
      const _send = XMLHttpRequest.prototype.send;
      XMLHttpRequest.prototype.open = function(...a){ this._url=a[1]; return _open.apply(this,a); };
      XMLHttpRequest.prototype.send = function(...a){
        this.addEventListener('load', () => {
          try { bump(JSON.parse(this.responseText)); } catch {}
        });
        return _send.apply(this,a);
      };
    })();

    // opcional: se j√° existir um Bid ID na p√°gina, mostrar logo de cara
    // (troque "CURRENT_BID_ID" se voc√™ tiver essa info dispon√≠vel)
    // showNextSteps({ bidId: CURRENT_BID_ID });

    document.getElementById('btnCreateBid').onclick = async ()=>{
      const auctionUrl = document.querySelector('#auUrl').value.trim();
      const patientId = document.querySelector('#patientId').value.trim();
      const amountCents = Number(document.querySelector('#amountCents').value || 0);
      const isImmediate = document.querySelector('#isImmediate').value === 'true';
      const specialty = document.querySelector('#specialty')?.value || '';
      const scheduledFor = document.querySelector('#scheduledFor').value; // ISO

      const body = { patientId, amountCents, mode: isImmediate ? 'immediate' : 'scheduled' };
      if (specialty) body.specialty = specialty;
      if (!isImmediate && scheduledFor) body.scheduledFor = new Date(scheduledFor).toISOString();

      const out = document.getElementById('outCreateBid'); out.textContent='Enviando‚Ä¶';
      try{
        const res = await fetch(`${auctionUrl}/bids`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();   // se res.ok, data.bid.id ter√° o ID
        if(res.ok && data?.bid?.id){
          document.getElementById('bidId').value = data.bid.id;
          out.innerHTML = '<span class="ok">Criado</span>';
          if(window.onBidCreated) window.onBidCreated({bidId: data.bid.id});  // Chama fun√ß√£o dos pr√≥ximos passos
        }else{
          out.innerHTML = `<span class="bad">Falha: ${data?.error || res.status}</span>`;
        }
        log('create-bid', data);
      }catch(e){
        out.innerHTML = '<span class="bad">Erro</span>'; log('create-bid erro', {error:String(e)});
      }
    };

    document.getElementById('btnAcceptBid').onclick = async ()=>{
      const auctionUrl = document.querySelector('#auUrl').value.trim();
      const bidId = document.getElementById('bidId').value;
      const mode = document.getElementById('mode').value;
      const patientId = document.getElementById('patientId').value.trim();
      const out = document.getElementById('outAcceptBid');
      if(!bidId){ out.innerHTML='<span class="bad">Informe o Bid ID</span>'; return; }
      
      out.textContent='Enviando‚Ä¶';
      try{
        const r = await fetch(`${auctionUrl}/bids/${bidId}/accept`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode,                  // "immediate" ou "scheduled"
            patientId              // obrigat√≥rio
          })
        });
        
        const j = await r.json();
        if(r.ok && j?.ok) {
          out.innerHTML = '<span class="ok">Consulta criada</span>';
          if(window.onBidAccepted) window.onBidAccepted({bidId: bidId, appointmentId: j?.appointment?.id});  // Chama fun√ß√£o dos pr√≥ximos passos
        } else {
          out.innerHTML = '<span class="bad">'+(j?.error||'Falha')+'</span>';
        }
        log('accept-bid', j);
      }catch(e){
        out.innerHTML = '<span class="bad">Erro</span>'; log('accept-bid erro', {error:String(e)});
      }
    };
  </script>

<script>
  (function () {
    const params = new URLSearchParams(location.search);
    const pid = params.get('patientId') || params.get('cpf'); // fallback, caso venha como cpf
    if (!pid) return;

    // tente achar o input de patientId nos dois layouts mais comuns
    const candidates = [
      document.querySelector('input[name="patientId"]'),
      document.querySelector('#patientId'),
    ].filter(Boolean);

    if (candidates.length) {
      candidates[0].value = pid;
      // opcional: rolar at√© a se√ß√£o do leil√£o
      const section = document.querySelector('h1, h2, h3');
      if (section) section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  })();
</script>

  <!-- [TELEMED waitroom patch] Next Steps auto-card -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // garante a exist√™ncia do container "Pr√≥ximos passos"
      let $next = document.getElementById('next-steps');
      if (!$next) {
        $next = document.createElement('div');
        $next.id = 'next-steps';
        $next.className = 'card';
        $next.style.marginTop = '16px';
        $next.style.padding = '16px';
        $next.style.border = '1px solid #0ea5e9';
        $next.style.background = '#eef7ff';
        $next.innerHTML = `
          <h4 style="margin:0 0 8px">Pr√≥ximos passos</h4>
          <ol style="margin:0;padding-left:18px">
            <li>Aguarde criar/aceitar o BID‚Ä¶</li>
            <li>Opcional: <a target="_blank" href="/example-integration.html#scribe">Abrir Scribe/CIDs</a></li>
            <li><a href="/index.html">Voltar ao Hub</a></li>
          </ol>`;
        // coloca no final do conte√∫do principal
        (document.querySelector('#content, main, .container') || document.body).appendChild($next);
      }

      // fun√ß√£o que escreve os links no card
      function showNextSteps({ bidId, appointmentId }) {
        const room     = String(appointmentId || bidId || 'telemed-demo');
        const waitUrl  = `/sala-de-espera.html?appointmentId=${encodeURIComponent(room)}`;
        const consultaUrlDoctor = `/consulta/?appointmentId=${encodeURIComponent(room)}&role=doctor`;
        $next.innerHTML = `
          <h4 style="margin:0 0 8px">Pr√≥ximos passos</h4>
          <ol style="margin:0;padding-left:18px">
            ${bidId ? `<li>Bid criado: <code>${bidId}</code>.</li>` : ''}
            ${appointmentId ? `
              <li>Consulta criada: <code>${appointmentId}</code></li>
              <li>Paciente: abrir a <a target="_blank" href="${waitUrl}">Sala de Espera</a>.</li>
              <li>M√©dico: entrar na <a target="_blank" href="${consultaUrlDoctor}">Sala de V√≠deo</a>.</li>
            ` : `
              <li>Com o Bid ID, aceite o lance (lado direito) para criar a consulta.</li>
            `}
            <li>Opcional: <a target="_blank" href="/example-integration.html#scribe">Abrir Scribe/CIDs</a></li>
            <li><a href="/index.html">Voltar ao Hub</a></li>
          </ol>`;
      }

      // encaixa sem quebrar handlers existentes
      const attach = (name) => {
        const prev = window[name];
        window[name] = (res) => {
          try { if (typeof prev === 'function') prev(res); } catch(e){}
          showNextSteps(res || {});
        };
      };
      attach('onBidCreated');   // espera { bidId }
      attach('onBidAccepted');  // espera { bidId, appointmentId }

      // exp√µe global caso queira chamar manualmente
      window.showNextSteps = showNextSteps;
    });
    <!-- ========= [TELEMED] Card ultra-simples de Pr√≥ximos Passos ========= -->
    <style>
      .ns-wrap{margin-top:16px;border:1px solid #0ea5e9;background:#eef7ff;border-radius:12px;padding:16px}
      .ns-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}
      .ns-btn{appearance:none;border:0;border-radius:10px;padding:14px 16px;font-weight:700;cursor:pointer}
      .ns-patient{background:#22c55e;color:#08310f}
      .ns-doctor{background:#3b82f6;color:#061a3a}
      .ns-ghost{background:transparent;border:1px solid #94a3b8;color:#0f172a}
      .ns-muted{color:#475569;font-size:13px}
      @media (max-width:700px){ .ns-row{grid-template-columns:1fr} }
    </style>

    <div id="next-steps" class="ns-wrap">
      <h4 style="margin:0 0 6px">Pr√≥ximos passos</h4>
      <div class="ns-muted">Crie o BID e use os bot√µes abaixo.</div>
      <div class="ns-row" style="margin-top:10px">
        <button class="ns-btn ns-patient" id="nsBtnPatient">üôã Sou Paciente ‚Äî Sala de Espera</button>
        <button class="ns-btn ns-doctor"  id="nsBtnDoctor">ü©∫ Sou M√©dico ‚Äî Sala de V√≠deo</button>
      </div>
      <div class="ns-row" style="margin-top:10px">
        <button class="ns-btn ns-ghost" id="nsBtnCopy">üìã Copiar link do Paciente</button>
        <button class="ns-btn ns-ghost" id="nsBtnBoth">ü™ü Abrir 2 janelas (simular)</button>
      </div>
      <div id="nsInfo" class="ns-muted" style="margin-top:6px"></div>
      <ol style="margin:10px 0 0 18px">
        <li>Paciente: clique em <b>‚ÄúSou Paciente ‚Äî Sala de Espera‚Äù</b>.</li>
        <li>M√©dico: clique em <b>‚ÄúSou M√©dico ‚Äî Sala de V√≠deo‚Äù</b> em outra aba.</li>
        <li>Ao <b>aceitar o BID</b>, a sala troca automaticamente para o ID da consulta.</li>
      </ol>
    </div>

    <script>
      // P√°gina de v√≠deo (agora usa /consulta/ com role)
      const VIDEO_PAGE = "/consulta/";

      function renderNextSteps({ bidId, appointmentId }) {
        const room = String(appointmentId || bidId || "telemed-demo");
        const waitUrl  = `/sala-de-espera.html?appointmentId=${encodeURIComponent(room)}`;
        const videoUrl = `${VIDEO_PAGE}?appointmentId=${encodeURIComponent(room)}&role=doctor`;

        // bot√µes
        const byId = (id) => document.getElementById(id);
        byId("nsBtnPatient").onclick = () => window.open(waitUrl, "_blank");
        byId("nsBtnDoctor").onclick  = () => window.open(videoUrl, "_blank");
        byId("nsBtnCopy").onclick    = async () => {
          try { await navigator.clipboard.writeText(location.origin + waitUrl);
            info("Link da Sala de Espera copiado ‚úî");
          } catch { info("N√£o consegui copiar. Clique com o bot√£o direito e copie o link do bot√£o 'Sou Paciente'."); }
        };
        byId("nsBtnBoth").onclick    = () => { window.open(waitUrl, "_blank"); window.open(videoUrl, "_blank"); };

        // texto auxiliar super claro
        const usingProvisional = !appointmentId && !!bidId;
        const infoText = [
          bidId ? `Bid: ${bidId}` : "Crie o BID para habilitar os bot√µes.",
          appointmentId
            ? `Consulta: ${appointmentId}`
            : usingProvisional
              ? "Usando o Bid ID como sala provis√≥ria at√© aceitar o BID."
              : "Aguarde criar o BID.",
          `Sala atual: ${room}`
        ].join(" ‚Ä¢ ");
        info(infoText);

        function info(t){ document.getElementById("nsInfo").textContent = t; }
      }

      // Integra com os handlers j√° existentes
      const hook = (name) => {
        const prev = window[name];
        window[name] = (res) => { try { if (typeof prev === "function") prev(res); } catch {}
          renderNextSteps(res || {});
        };
      };
      hook("onBidCreated");   // espera { bidId }
      hook("onBidAccepted");  // espera { bidId, appointmentId }

      // primeiro estado (sem nada): ainda assim deixa os bot√µes prontos para demo
      renderNextSteps({});
    </script>
    <!-- ========= [TELEMED] Fim do Card ========= -->

  </script>
</body>
</html>