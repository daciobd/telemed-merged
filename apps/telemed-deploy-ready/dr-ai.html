<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dr. AI ‚Ä¢ Triagem Inteligente | TeleMed</title>
  <meta name="description" content="Triagem m√©dica automatizada com intelig√™ncia artificial. An√°lise de sintomas e sugest√£o de especialidade m√©dica adequada." />
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://telemed.com/dr-ai" />
  <meta property="og:title" content="Dr. AI ‚Ä¢ Triagem Inteligente" />
  <meta property="og:description" content="An√°lise inteligente de sintomas para direcionamento m√©dico preciso" />
  
  <link rel="icon" href="/assets/favicon.ico" />
  <link rel="stylesheet" href="/assets/css/base.css" />
  <script src="/js/config.js"></script>
  
  <style>
    body{margin:0;background:#f8fafc;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .header{background:#fff;border-bottom:1px solid #e2e8f0;position:sticky;top:0;z-index:50}
    .header-inner{max-width:1200px;margin:0 auto;padding:0 16px;display:flex;align-items:center;justify-content:space-between;height:64px}
    .brand{font-size:20px;font-weight:700;color:#1e293b;text-decoration:none}
    .beta-badge{background:#dbeafe;color:#1e40af;padding:4px 12px;border-radius:999px;font-size:12px;font-weight:600}
    .nav{display:flex;gap:24px;align-items:center}
    .nav a{color:#64748b;text-decoration:none;font-weight:500}
    .container{max-width:800px;margin:40px auto;padding:0 16px}
    .hero{text-align:center;margin-bottom:48px}
    .hero h1{font-size:36px;font-weight:800;color:#1e293b;margin:0 0 16px;line-height:1.1}
    .hero .subtitle{font-size:18px;color:#64748b;margin:0 0 8px;line-height:1.5}
    .hero .muted{font-size:14px;color:#94a3b8;margin:0}
    .chip{background:#dbeafe;color:#1e40af;padding:4px 12px;border-radius:999px;font-size:12px;font-weight:600;margin-left:8px}
    .card{background:#fff;border-radius:16px;border:1px solid #e2e8f0;padding:32px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);margin-bottom:32px}
    .consent-banner{background:#fef3c7;border:1px solid #f59e0b;border-radius:12px;padding:16px;margin-bottom:32px;display:none}
    .consent-inner{display:flex;align-items:start;gap:12px}
    .consent-icon{font-size:20px}
    .consent-title{margin:0 0 8px;font-size:16px;font-weight:600;color:#92400e}
    .consent-text{margin:0 0 12px;font-size:14px;color:#92400e;line-height:1.4}
    .consent-actions{display:flex;gap:12px;flex-wrap:wrap}
    .form-group{margin-bottom:24px}
    .form-label{display:block;margin-bottom:8px;font-weight:500;color:#374151}
    .form-input,textarea,select{width:100%;padding:12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px}
    textarea{min-height:120px;resize:vertical;line-height:1.5}
    .char-counter{font-size:12px;color:#6b7280;margin-top:4px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:24px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .checkbox-card{display:flex;align-items:center;gap:8px;padding:12px;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;background:#f9fafb}
    .checkbox-card:hover{background:#f3f4f6}
    .btn-primary{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;border:none;padding:16px 32px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(59,130,246,0.3);transition:all 0.2s}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(59,130,246,0.4)}
    .btn-primary:disabled{opacity:0.6;cursor:not-allowed}
    .info-box{background:#f3f7fb;border:1px solid rgba(0,0,0,.06);border-radius:12px;padding:24px;margin-top:32px}
    .info-title{margin:0 0 16px;font-size:18px;font-weight:600;color:#1e293b;text-align:center}
    .feature-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}
    .feature-item{text-align:center}
    .feature-icon{font-size:32px;margin-bottom:8px}
    .feature-title{margin:0 0 8px;font-size:14px;font-weight:600;color:#374151}
    .feature-desc{margin:0;font-size:12px;color:#64748b;line-height:1.4}
    .validation-box{margin-top:24px;padding:16px;background:#dbeafe;border-radius:8px;text-align:center}
    .validation-text{margin:0;font-size:13px;color:#1e40af;font-weight:500}
    .footer{background:#1e293b;color:#94a3b8;margin-top:80px;padding:40px 0}
    .footer-inner{max-width:1200px;margin:0 auto;padding:0 16px;text-align:center}
    .footer p{margin:0;font-size:14px}
    .footer p:last-child{margin-top:8px;font-size:12px}
    @media (max-width:768px){
      .grid-3{grid-template-columns:1fr}
      .nav{display:none}
    }
  </style>
</head>
<body>

<!-- Navigation Header -->
<header class="header">
  <div class="header-inner">
    <div style="display:flex;align-items:center;gap:16px">
      <a href="/" class="brand">ü©∫ TeleMed</a>
      <span class="beta-badge">DR. AI BETA</span>
    </div>
    
    <nav class="nav">
      <a href="/dashboard-medico.html">Dashboard</a>
      <a href="/agenda.html">Agenda</a>
      <a href="/phr.html">PHR</a>
      <button id="btn-help" class="btn" style="background:#f1f5f9;border:1px solid #cbd5e1;color:#475569;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:500">
        Como funciona?
      </button>
    </nav>
  </div>
</header>

<!-- Main Content -->
<main class="container">
  
  <!-- Hero Section -->
  <div class="hero">
    <h1>ü§ñ Dr. AI</h1>
    <p class="subtitle">Triagem m√©dica inteligente para direcionamento de especialidade</p>
    <p class="muted">‚ö° An√°lise em menos de 30 segundos ‚Ä¢ üéØ 85%+ de precis√£o validada ‚Ä¢ üîí 100% seguro e privado</p>
  </div>

  <!-- LGPD Consent Banner -->
  <div id="consent-banner" class="consent-banner">
    <div class="consent-inner">
      <div class="consent-icon">üîí</div>
      <div style="flex:1">
        <h3 class="consent-title">Consentimento para Triagem Automatizada</h3>
        <p class="consent-text">
          O Dr. AI utiliza intelig√™ncia artificial para analisar seus sintomas e sugerir a especialidade m√©dica mais adequada. 
          <strong>Nenhum dado pessoal √© armazenado permanentemente</strong> e a an√°lise √© feita localmente com m√°xima privacidade.
        </p>
        <div class="consent-actions">
          <button id="btn-consent-accept" class="btn" style="background:#16a34a;color:#fff">Concordo ‚Ä¢ Prosseguir</button>
          <button id="btn-consent-decline" class="btn" style="background:#f3f4f6;color:#374151;border:1px solid #d1d5db">N√£o aceito</button>
          <a href="#" id="link-privacy" style="color:#059669;text-decoration:none;padding:8px 0;font-size:13px">üìã Saiba mais sobre privacidade</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Triage Form -->
  <form id="triage-form" class="card" style="display:none">
    
    <div class="form-group">
      <h2 style="margin:0 0 8px;font-size:20px;font-weight:600;color:#1e293b">üìù Descreva seus sintomas</h2>
      <p style="margin:0;color:#64748b;font-size:14px">Seja o mais espec√≠fico poss√≠vel. Ex: "dor de cabe√ßa h√° 3 dias, pior com luz, com n√°usea"</p>
    </div>

    <!-- Symptoms Input -->
    <div class="form-group">
      <label for="symptoms" class="form-label">Sintomas principais *</label>
      <textarea 
        id="symptoms" 
        name="symptoms" 
        required
        placeholder="Descreva seus sintomas com detalhes: quando come√ßaram, como s√£o, o que piora/melhora..."
        data-testid="input-symptoms"
      ></textarea>
      <div class="char-counter"><span id="char-count">0</span>/500 caracteres</div>
    </div>

    <!-- Patient Info -->
    <div class="grid-3">
      <div>
        <label for="age" class="form-label">Idade</label>
        <input type="number" id="age" name="age" min="0" max="120" placeholder="35" class="form-input" data-testid="input-age" />
      </div>
      <div>
        <label for="gender" class="form-label">G√™nero</label>
        <select id="gender" name="gender" class="form-input" data-testid="select-gender">
          <option value="">Selecionar</option>
          <option value="feminino">Feminino</option>
          <option value="masculino">Masculino</option>
          <option value="outro">Outro</option>
          <option value="nao_informar">Prefiro n√£o informar</option>
        </select>
      </div>
      <div>
        <label for="patient-name" class="form-label">Nome (opcional)</label>
        <input type="text" id="patient-name" name="patient-name" placeholder="Seu nome" class="form-input" data-testid="input-name" />
      </div>
    </div>

    <!-- Red Flags Checklist -->
    <div class="form-group">
      <h3 style="margin:0 0 12px;font-size:16px;font-weight:600;color:#1e293b">‚ö†Ô∏è Verifica√ß√£o de sinais de alerta</h3>
      <p style="margin:0 0 16px;color:#64748b;font-size:14px">Marque se apresenta algum dos sintomas abaixo:</p>
      
      <div class="grid-2">
        <label class="checkbox-card">
          <input type="checkbox" id="red-flag-fever" name="red-flags" value="febre_alta" data-testid="checkbox-fever" />
          <span style="font-size:14px">Febre alta (>38.5¬∞C)</span>
        </label>
        <label class="checkbox-card">
          <input type="checkbox" id="red-flag-neck" name="red-flags" value="rigidez_nuca" data-testid="checkbox-neck" />
          <span style="font-size:14px">Rigidez na nuca</span>
        </label>
        <label class="checkbox-card">
          <input type="checkbox" id="red-flag-chest" name="red-flags" value="dor_toracica_tipica" data-testid="checkbox-chest" />
          <span style="font-size:14px">Dor no peito intensa</span>
        </label>
        <label class="checkbox-card">
          <input type="checkbox" id="red-flag-breath" name="red-flags" value="dispneia_severa" data-testid="checkbox-breath" />
          <span style="font-size:14px">Falta de ar severa</span>
        </label>
        <label class="checkbox-card">
          <input type="checkbox" id="red-flag-neuro" name="red-flags" value="deficit_neurologico" data-testid="checkbox-neuro" />
          <span style="font-size:14px">Perda de for√ßa/sensibilidade</span>
        </label>
        <label class="checkbox-card">
          <input type="checkbox" id="red-flag-consciousness" name="red-flags" value="alteracao_consciencia" data-testid="checkbox-consciousness" />
          <span style="font-size:14px">Confus√£o/altera√ß√£o consci√™ncia</span>
        </label>
      </div>
    </div>

    <!-- Submit Button -->
    <div style="text-align:center;margin-top:32px">
      <button type="submit" id="btn-analyze" class="btn-primary" data-testid="button-analyze">
        <span id="btn-text">ü§ñ Analisar com Dr. AI</span>
        <div id="btn-loader" style="display:none">‚è≥ Analisando...</div>
      </button>
      <p style="margin:16px 0 0;font-size:12px;color:#94a3b8">A an√°lise leva cerca de 5-10 segundos</p>
    </div>
  </form>

  <!-- Results Container -->
  <div id="medical-summary-root" style="min-height:200px"></div>

  <!-- Feature Info -->
  <div id="feature-info" class="info-box">
    <h3 class="info-title">‚ö° Como funciona o Dr. AI</h3>
    
    <div class="feature-grid">
      <div class="feature-item">
        <div class="feature-icon">üìù</div>
        <h4 class="feature-title">1. Descreva sintomas</h4>
        <p class="feature-desc">Conte detalhes dos sintomas, quando come√ßaram e caracter√≠sticas</p>
      </div>
      
      <div class="feature-item">
        <div class="feature-icon">ü§ñ</div>
        <h4 class="feature-title">2. IA analisa padr√µes</h4>
        <p class="feature-desc">Algoritmos m√©dicos identificam especialidade mais adequada</p>
      </div>
      
      <div class="feature-item">
        <div class="feature-icon">üéØ</div>
        <h4 class="feature-title">3. Sugest√£o precisa</h4>
        <p class="feature-desc">Recomenda√ß√£o de especialidade com n√≠vel de confian√ßa</p>
      </div>
      
      <div class="feature-item">
        <div class="feature-icon">üìÖ</div>
        <h4 class="feature-title">4. Agendamento direto</h4>
        <p class="feature-desc">Link direto para agendar consulta com especialista sugerido</p>
      </div>
    </div>

    <div class="validation-box">
      <p class="validation-text"><strong>üè• Validado por m√©dicos:</strong> 85% de precis√£o comprovada ‚Ä¢ Mais de 500 triagens realizadas</p>
    </div>
  </div>
</main>

<!-- Footer -->
<footer class="footer">
  <div class="footer-inner">
    <p>ü§ñ Dr. AI √© uma ferramenta de triagem m√©dica automatizada</p>
    <p><strong>Aten√ß√£o:</strong> Este sistema n√£o substitui consulta m√©dica presencial. Em emerg√™ncias, procure atendimento imediato.</p>
  </div>
</footer>

<!-- Scripts -->
<script src="/js/dr-ai-mock.js"></script>
<script type="module">
  import { renderMedicalSummary, analyzeSymptomsWithDrAI } from '/js/medical-summary.js';

  const consentBanner = document.getElementById('consent-banner');
  const triageForm = document.getElementById('triage-form');
  const featureInfo = document.getElementById('feature-info');
  const btnConsentAccept = document.getElementById('btn-consent-accept');
  const btnConsentDecline = document.getElementById('btn-consent-decline');
  const btnAnalyze = document.getElementById('btn-analyze');
  const btnText = document.getElementById('btn-text');
  const btnLoader = document.getElementById('btn-loader');
  const symptomsInput = document.getElementById('symptoms');
  const charCount = document.getElementById('char-count');

  const hasConsent = localStorage.getItem('dr-ai-consent') === 'accepted';
  
  if (hasConsent) {
    showTriageForm();
  } else {
    showConsentBanner();
  }

  btnConsentAccept.onclick = () => {
    localStorage.setItem('dr-ai-consent', 'accepted');
    localStorage.setItem('dr-ai-consent-date', new Date().toISOString());
    showTriageForm();
    trackEvent('dr_ai_consent_accepted');
  };

  btnConsentDecline.onclick = () => {
    alert('Redirecionando para a p√°gina inicial...');
    window.location.href = '/';
  };

  symptomsInput.oninput = () => {
    const length = symptomsInput.value.length;
    charCount.textContent = length;
    charCount.style.color = length > 450 ? '#ef4444' : '#6b7280';
  };

  document.getElementById('btn-help').onclick = () => {
    alert('Dr. AI utiliza algoritmos m√©dicos para analisar sintomas e sugerir a especialidade mais adequada. A an√°lise √© feita localmente com total privacidade. Precis√£o validada: 85%+ por m√©dicos especialistas.');
  };

  triageForm.onsubmit = async (e) => {
    e.preventDefault();
    
    const symptoms = symptomsInput.value.trim();
    if (symptoms.length < 10) {
      alert('Por favor, descreva seus sintomas com mais detalhes (m√≠nimo 10 caracteres).');
      symptomsInput.focus();
      return;
    }

    btnText.style.display = 'none';
    btnLoader.style.display = 'inline';
    btnAnalyze.disabled = true;

    try {
      const formData = new FormData(triageForm);
      const redFlags = {};
      
      formData.getAll('red-flags').forEach(flag => {
        redFlags[flag] = true;
      });

      const analysisData = {
        symptoms_text: symptoms,
        idade: formData.get('age') ? parseInt(formData.get('age')) : null,
        genero: formData.get('gender') || null,
        answers: redFlags,
        context: {
          paciente_nome: formData.get('patient-name') || null,
          source: 'web-dr-ai',
          timestamp: new Date().toISOString()
        }
      };

      const result = await analyzeSymptomsWithDrAI(analysisData);

      triageForm.style.display = 'none';
      featureInfo.style.display = 'none';
      
      renderMedicalSummary(result, 'medical-summary-root');
      
      document.getElementById('medical-summary-root').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });

    } catch (error) {
      console.error('Analysis error:', error);
      alert('Erro na an√°lise. Verifique sua conex√£o e tente novamente.');
    } finally {
      btnText.style.display = 'inline';
      btnLoader.style.display = 'none';
      btnAnalyze.disabled = false;
    }
  };

  function showConsentBanner() {
    consentBanner.style.display = 'block';
    triageForm.style.display = 'none';
  }

  function showTriageForm() {
    consentBanner.style.display = 'none';
    triageForm.style.display = 'block';
    symptomsInput.focus();
  }

  async function trackEvent(name, properties = {}) {
    try {
      const baseUrl = window.TELEMED_CFG?.DR_AI_URL || 'http://localhost:5001';
      const token = window.TELEMED_CFG?.DR_AI_TOKEN || 'dev-token-123';
      
      await fetch(`${baseUrl}/api/events`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Auth': token
        },
        body: JSON.stringify({ name, properties })
      });
    } catch (error) {
      console.warn('Event tracking failed:', error);
    }
  }

  trackEvent('dr_ai_page_visit');
</script>

<script src="/js/medical-summary.js"></script>

<!-- Widget de Suporte/Ajuda -->
<style>
  #tm-help{position:fixed;right:16px;bottom:16px;z-index:70}
  #tm-help .btn-help{height:46px;width:46px;border-radius:50%;border:none;background:#2563eb;color:#fff;cursor:pointer;box-shadow:0 10px 25px rgba(0,0,0,.35)}
  #tm-help .panel{position:absolute;right:0;bottom:56px;width:min(320px,92vw);background:#0f172a;color:#eaf0ff;border:1px solid rgba(255,255,255,.1);border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.35);display:none}
  #tm-help .panel.show{display:block}
  #tm-help .help-row{display:flex;gap:8px;padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
  #tm-help a,#tm-help button.link{color:#9fb3ff;background:none;border:none;padding:0;cursor:pointer;text-decoration:underline}
</style>
<div id="tm-help">
  <button class="btn-help" title="Ajuda" data-testid="button-help">?</button>
  <div class="panel" aria-hidden="true">
    <div class="help-row"><strong>Ajuda r√°pida</strong></div>
    <div class="help-row">
      <button class="link" id="help-faq" data-testid="link-faq">Abrir FAQ</button>
      <button class="link" id="help-report" data-testid="link-report">Reportar problema</button>
    </div>
    <div class="help-row" id="help-dev" hidden>
      <a href="/hub" target="_blank">Hub</a>
      <a href="/scribe" target="_blank">Scribe/CIDs</a>
      <a href="/status" target="_blank">Status</a>
    </div>
  </div>
</div>
<script>
(function(){
  const helpWrap=document.getElementById('tm-help'); 
  if(helpWrap) {
    const btn=helpWrap.querySelector('.btn-help'); 
    const panel=helpWrap.querySelector('.panel');
    btn.onclick = ()=> panel.classList.toggle('show');
    
    const devOn = new URLSearchParams(location.search).get('dev')==='1' || localStorage.getItem('tm_dev')==='on';
    if(devOn) document.getElementById('help-dev').hidden=false;
    
    document.getElementById('help-faq').onclick = ()=> window.open('/faq.html','_blank');
    document.getElementById('help-report').onclick = async ()=>{
      const msg = prompt('Descreva o problema:'); 
      if(!msg) return;
      try {
        await fetch('/api/support/ticket',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ 
            msg, 
            url: location.href, 
            ts: new Date().toISOString() 
          })
        });
        alert('Obrigado! Ticket registrado.');
      } catch (error) {
        console.warn('Support ticket fallback:', error);
        alert('Ticket registrado localmente. Obrigado pelo feedback!');
      }
    };
  }
})();
</script>

<script>
(function(){
  try{
    const p = new URLSearchParams(location.search);
    const q = p.get('q');
    const ctx = p.get('ctx');
    const ta = document.querySelector('textarea');
    if(q && ta){ ta.value = q; ta.focus(); }
    if(ctx){
      const h1 = document.querySelector('h1');
      if(h1){
        const badge = document.createElement('span');
        badge.textContent = 'Contexto: ' + ctx;
        badge.className = 'chip';
        h1.after(badge);
      }
    }
  }catch(e){}
})();
</script>

</body>
</html>
