<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>An√°lise de Exames (demo) ‚Äî TeleMed</title>
  <link rel="stylesheet" href="/assets/css/base.css" />
  <style>
    .container{max-width:980px;margin:36px auto;padding:16px}
    .subtitle{color:var(--muted);margin-bottom:16px}
    .muted{color:var(--muted)}
    .stack>*{margin:10px 0}
    textarea{width:100%;min-height:140px;padding:12px;border:1px solid var(--border);border-radius:8px;font-family:monospace;font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(0,0,0,.08);text-align:left}
    th{background:var(--input);font-weight:600}
    .flag-ok{color:#1a7f37;font-weight:600}
    .flag-alt{color:#b42318;font-weight:700}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .chip{background:var(--panel);border:1px solid var(--primary);border-radius:999px;padding:4px 12px;font-size:13px;font-weight:500}
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
    canvas{width:100%;max-width:720px;height:200px;border:1px solid var(--border);border-radius:10px;margin-top:12px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:16px}
    .info-box{background:var(--panel);border:1px solid var(--primary);border-radius:12px;padding:12px;margin:12px 0}
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()" aria-label="Alternar tema" data-testid="button-toggle-theme">
    <span class="dark-icon">‚òÄÔ∏è</span>
    <span class="light-icon">üåô</span>
  </button>
  <div class="container stack">
    <h1>üìä An√°lise de Exames (demo)</h1>
    <div class="subtitle">Cole um CSV simples e gere rapidamente uma tabela com <strong>flags autom√°ticos</strong> e um gr√°fico de tend√™ncia da <em>Glicemia</em>. Nenhum dado real √© armazenado.</div>

    <div class="info-box">
      <strong>üí° Dica:</strong> Clique em "Carregar exemplo" para ver o formato CSV esperado e testar a an√°lise automaticamente.
    </div>

    <details class="card">
      <summary style="cursor:pointer"><strong>üìã Formato esperado (CSV)</strong></summary>
      <pre class="muted" style="white-space:pre-wrap;margin-top:8px;font-size:13px">Data,Exame,Valor,Unidade
2025-09-20,Glicemia,112,mg/dL
2025-10-05,Glicemia,132,mg/dL
2025-10-05,Hemoglobina,12.1,g/dL
2025-10-05,Creatinina,1.4,mg/dL</pre>
    </details>

    <div class="actions">
      <button class="btn" id="btnExemplo" data-cta="analise_demo_exemplo" data-testid="button-exemplo">üì• Carregar exemplo</button>
      <button class="btn" id="btnProcessar" data-cta="analise_demo_processar" data-testid="button-processar">‚ö° Processar</button>
      <button class="btn" id="btnPrint" data-cta="analise_demo_print" data-testid="button-print">üñ®Ô∏è Imprimir / Salvar PDF</button>
      <a class="btn" id="btnAskAI" href="#" data-cta="analise_demo_ask_ai" data-testid="button-ask-ai">ü§ñ Conferir com Dr. AI</a>
    </div>

    <textarea id="inputCSV" aria-label="√Årea para colar CSV de exames" placeholder="Cole aqui seu CSV de exames..." data-testid="input-csv"></textarea>

    <div id="outResumo" class="chips" aria-live="polite"></div>
    
    <div id="outTabela" class="card" style="display:none" data-testid="output-tabela">
      <h3>Resultados dos Exames</h3>
      <table aria-label="Tabela de resultados com flags">
        <thead><tr><th>Data</th><th>Exame</th><th>Valor</th><th>Unidade</th><th>Refer√™ncia*</th><th>Status</th></tr></thead>
        <tbody id="tblBody"></tbody>
      </table>
      <p class="muted" style="margin-top:12px;font-size:13px">* Refer√™ncias aproximadas (demo). Avalia√ß√£o cl√≠nica obrigat√≥ria.</p>
    </div>

    <div id="outGrafico" class="card" style="display:none" data-testid="output-grafico">
      <h3>Tend√™ncia ‚Äî Glicemia</h3>
      <canvas id="chart"></canvas>
    </div>

    <p><a href="/public/mod-analise.html" class="muted" data-testid="link-back">‚Üê Voltar ao M√≥dulo de An√°lise</a></p>
  </div>

  <script>
    // Telemetria
    window.__BUILD='pilot-r1';
    try{ window.Telemetry?.event?.({event_name:'page_view', meta:{page:'/public/analise-exames-demo.html'}});}catch(e){}
    document.querySelectorAll('[data-cta]').forEach(el=>{
      el.addEventListener('click',()=>{ try{ window.Telemetry?.event?.({event_name:'cta_click', meta:{name:el.dataset.cta}});}catch(e){} });
    });

    const csvArea = document.getElementById('inputCSV');
    const tblBody = document.getElementById('tblBody');
    const outTabela = document.getElementById('outTabela');
    const outGrafico = document.getElementById('outGrafico');
    const outResumo = document.getElementById('outResumo');

    document.getElementById('btnExemplo').addEventListener('click', ()=>{
      csvArea.value = `Data,Exame,Valor,Unidade
2025-09-20,Glicemia,112,mg/dL
2025-10-05,Glicemia,132,mg/dL
2025-10-05,Hemoglobina,12.1,g/dL
2025-10-05,Creatinina,1.4,mg/dL`;
    });

    document.getElementById('btnProcessar').addEventListener('click', processar);
    document.getElementById('btnPrint').addEventListener('click', ()=>window.print());

    const refRanges = {
      'Glicemia': (v)=> {
        if (v < 100) return {ref:'<100', flag:'OK'};
        if (v >=100 && v <=125) return {ref:'100‚Äì125 (pr√©-diabetes)', flag:'ALTERADO'};
        return {ref:'‚â•126 (diabetes)', flag:'ALTERADO'};
      },
      'Hemoglobina': (v)=> {
        if (v < 12.0) return {ref:'12‚Äì17 g/dL (aprox.)', flag:'BAIXO'};
        if (v > 17.0) return {ref:'12‚Äì17 g/dL (aprox.)', flag:'ALTO'};
        return {ref:'12‚Äì17 g/dL (aprox.)', flag:'OK'};
      },
      'Creatinina': (v)=> {
        if (v < 0.6) return {ref:'0.6‚Äì1.3 mg/dL (aprox.)', flag:'BAIXO'};
        if (v > 1.3) return {ref:'0.6‚Äì1.3 mg/dL (aprox.)', flag:'ALTO'};
        return {ref:'0.6‚Äì1.3 mg/dL (aprox.)', flag:'OK'};
      }
    };

    function parseCSV(txt){
      const lines = txt.trim().split(/\r?\n/);
      if (!lines.length) return [];
      const rows = [];
      for (let i=1;i<lines.length;i++){
        const parts = lines[i].split(',');
        if (parts.length < 4) continue;
        const [data, exame, valor, unidade] = parts.map(s=>s.trim());
        const v = Number(valor.replace(',','.'));
        rows.push({data, exame, valor: isNaN(v)? null : v, unidade});
      }
      return rows;
    }

    function processar(){
      const txt = csvArea.value;
      if(!txt.trim()){ alert('Cole um CSV antes de processar.'); return; }
      const rows = parseCSV(txt);
      if(!rows.length){ alert('Nenhum dado v√°lido encontrado.'); return; }

      tblBody.innerHTML = '';
      outResumo.innerHTML = '';
      const alterados = [];

      rows.forEach(r=>{
        const fn = refRanges[r.exame];
        const res = fn ? fn(r.valor) : {ref:'N/A', flag:'N/A'};
        const tr = document.createElement('tr');
        const flagClass = res.flag==='OK'?'flag-ok':'flag-alt';
        tr.innerHTML = `<td>${r.data}</td><td>${r.exame}</td><td>${r.valor}</td><td>${r.unidade}</td><td>${res.ref}</td><td class="${flagClass}">${res.flag}</td>`;
        tblBody.appendChild(tr);

        if(res.flag!=='OK' && res.flag!=='N/A'){
          alterados.push(`${r.exame}: ${r.valor} ${r.unidade} (${res.flag})`);
        }
      });

      outTabela.style.display = 'block';

      if(alterados.length){
        alterados.forEach(a=>{
          const chip = document.createElement('div');
          chip.className = 'chip';
          chip.textContent = a;
          outResumo.appendChild(chip);
        });
      }

      const glicRows = rows.filter(r=>r.exame==='Glicemia').sort((a,b)=>new Date(a.data)-new Date(b.data));
      if(glicRows.length){
        outGrafico.style.display = 'block';
        drawChart(glicRows);
      }

      document.getElementById('btnAskAI').href = '/dr-ai.html?ctx=analise&q='+encodeURIComponent(buildQuestion(rows, alterados));
    }

    function buildQuestion(rows, alterados){
      const resumo = alterados.length ? `Altera√ß√µes: ${alterados.join('; ')}.` : 'Todos os valores dentro do esperado.';
      const todosExames = rows.map(r=>`${r.exame}: ${r.valor} ${r.unidade}`).join(', ');
      return `Analisar exames laboratoriais do paciente. ${resumo} Resultados: ${todosExames}. Comente poss√≠veis diagn√≥sticos diferenciais, necessidade de repetir exames/jejum, e orienta√ß√µes ao paciente. Seja objetivo.`;
    }

    function drawChart(data){
      const canvas = document.getElementById('chart');
      const ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.offsetWidth;
      const h = canvas.height = canvas.offsetHeight;
      ctx.clearRect(0,0,w,h);

      const vals = data.map(d=>d.valor);
      const min = Math.min(...vals)-10;
      const max = Math.max(...vals)+10;
      const step = w / (data.length-1||1);

      ctx.strokeStyle = '#2563eb';
      ctx.lineWidth = 2;
      ctx.beginPath();
      data.forEach((d,i)=>{
        const x = i*step;
        const y = h - ((d.valor - min)/(max-min))*h;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      ctx.fillStyle = '#2563eb';
      data.forEach((d,i)=>{
        const x = i*step;
        const y = h - ((d.valor - min)/(max-min))*h;
        ctx.beginPath();
        ctx.arc(x,y,4,0,2*Math.PI);
        ctx.fill();
        ctx.fillText(`${d.valor}`, x+6, y-6);
      });
    }
  </script>
  <script>
    // Theme Toggle
    function toggleTheme() {
      document.documentElement.classList.toggle('light-mode');
      const isLight = document.documentElement.classList.contains('light-mode');
      localStorage.setItem('telemed-theme', isLight ? 'light' : 'dark');
    }
    
    // Load saved theme
    const savedTheme = localStorage.getItem('telemed-theme');
    if (savedTheme === 'light') {
      document.documentElement.classList.add('light-mode');
    }
  </script>
</body>
</html>
