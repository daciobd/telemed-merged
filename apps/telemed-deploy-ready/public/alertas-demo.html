<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador de Alertas (demo) ‚Äî TeleMed</title>
  <link rel="stylesheet" href="/assets/css/base.css" />
  <style>
    .container{max-width:980px;margin:36px auto;padding:16px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    fieldset{border:1px solid rgba(0,0,0,.1);border-radius:12px;padding:12px}
    legend{font-weight:700}
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0}
    .feed{display:grid;gap:12px}
    .alert{border-radius:12px;padding:12px;border:1px solid rgba(0,0,0,.08);background:#f8fafc}
    .sev-info{border-left:6px solid #2563eb}
    .sev-attn{border-left:6px solid #d97706;background:#fff8ed}
    .sev-emer{border-left:6px solid #b91c1c;background:#fff1f2}
    .meta{font-size:12px;color:var(--muted)}
    .tag{background:#eef2ff;border-radius:999px;padding:2px 10px;font-size:12px;margin-left:6px}
    .btn-link{background:none;border:none;color:var(--accent);text-decoration:underline;cursor:pointer;font:inherit}
  </style>
</head>
<body>
  <div class="container">
    <h1>üîî Simulador de Alertas (demo)</h1>
    <p class="muted">Dispare situa√ß√µes cl√≠nicas comuns e veja o feed de alertas com severidade, a√ß√µes sugeridas e integra√ß√£o com o Dr. AI.</p>

    <div class="grid">
      <section>
        <fieldset>
          <legend>Perfil & Canal</legend>
          <div class="actions">
            <label data-testid="radio-paciente"><input type="radio" name="perfil" value="paciente" checked /> Paciente</label>
            <label data-testid="radio-medico"><input type="radio" name="perfil" value="medico" /> M√©dico</label>
          </div>
          <div class="actions">
            <label data-testid="checkbox-app"><input type="checkbox" id="canal_app" checked /> App (push)</label>
            <label data-testid="checkbox-email"><input type="checkbox" id="canal_email" /> Email</label>
            <label data-testid="checkbox-sms"><input type="checkbox" id="canal_sms" /> SMS</label>
          </div>
        </fieldset>

        <fieldset style="margin-top:12px">
          <legend>Regras r√°pidas (demo)</legend>
          <div class="actions" style="flex-direction:column;align-items:flex-start">
            <label data-testid="checkbox-febre"><input type="checkbox" class="regra" value="febre" /> Febre alta &gt; 38.5 ¬∞C (atendimento nas √∫ltimas 24‚Äì48h)</label>
            <label data-testid="checkbox-pa"><input type="checkbox" class="regra" value="pa_emerg" /> PA &gt;= 180/120 mmHg (emerg√™ncia)</label>
            <label data-testid="checkbox-hipoglic"><input type="checkbox" class="regra" value="hipoglic" /> Glicemia &lt; 60 mg/dL (hipoglicemia)</label>
            <label data-testid="checkbox-dose"><input type="checkbox" class="regra" value="dose_perdida" /> Esquecimento de dose (ades√£o)</label>
            <label data-testid="checkbox-consulta"><input type="checkbox" class="regra" value="consulta_expirada" /> Consulta expirada (sem retorno em 30 dias)</label>
            <label data-testid="checkbox-fora"><input type="checkbox" class="regra" value="fora_escopo" /> Fora de escopo (ex.: dor tor√°cica s√∫bita)</label>
          </div>
          <div class="actions">
            <button class="btn" id="btnDisparar" data-cta="alerts_demo_trigger" data-testid="button-disparar">Disparar selecionados</button>
            <button class="btn" id="btnExemplo" data-cta="alerts_demo_example" data-testid="button-exemplo">Disparar exemplo</button>
            <a class="btn" href="/dashboard-piloto.html" data-cta="alerts_demo_dash" data-testid="button-telemetria">Ver telemetria</a>
          </div>
        </fieldset>
      </section>

      <section>
        <fieldset style="height:100%">
          <legend>Feed de alertas</legend>
          <div id="feed" class="feed" aria-live="polite" aria-busy="false" data-testid="feed-alertas"></div>
        </fieldset>
      </section>
    </div>

    <p style="margin-top:14px"><a href="/public/mod-alertas.html" class="muted" data-testid="link-back">‚Üê Voltar ao M√≥dulo de Alertas</a></p>
  </div>

  <script>
    // Telemetria
    window.__BUILD='pilot-r1';
    try{ window.Telemetry?.event?.({event_name:'page_view', meta:{page:'/public/alertas-demo.html'}});}catch(e){}
    document.querySelectorAll('[data-cta]').forEach(el=>{
      el.addEventListener('click',()=>{ try{ window.Telemetry?.event?.({event_name:'cta_click', meta:{name:el.dataset.cta}});}catch(e){} });
    });

    const feed = document.getElementById('feed');
    const perfil = ()=> document.querySelector('input[name="perfil"]:checked').value;
    const canais = ()=>({
      app: document.getElementById('canal_app').checked,
      email: document.getElementById('canal_email').checked,
      sms: document.getElementById('canal_sms').checked,
    });

    const regras = {
      febre(){
        return {
          titulo:'Febre alta reportada',
          msg:'Temperatura > 38.5 ¬∞C nas √∫ltimas 24‚Äì48h.',
          sev:'attn',
          acao:'Orientar antit√©rmico, hidrata√ß√£o e sinais de alerta. Avaliar agendamento.',
          politica:'escala_emergencia=N√ÉO (orientar sinais de alarme).'
        };
      },
      pa_emerg(){
        return {
          titulo:'PA cr√≠tica',
          msg:'Press√£o arterial ‚â• 180/120 mmHg.',
          sev:'emer',
          acao:'Encaminhar para emerg√™ncia imediatamente. Orientar procurar atendimento 192/SAMU.',
          politica:'escala_emergencia=SIM.'
        };
      },
      hipoglic(){
        return {
          titulo:'Hipoglicemia prov√°vel',
          msg:'Glicemia < 60 mg/dL.',
          sev:'emer',
          acao:'Regra dos 15g de glicose e reavalia√ß√£o; se piora ou rebaixamento, emerg√™ncia.',
          politica:'escala_emergencia=DEPENDE (avaliar sintomas).'
        };
      },
      dose_perdida(){
        return {
          titulo:'Poss√≠vel baixa ades√£o',
          msg:'Paciente reportou esquecimento de doses.',
          sev:'info',
          acao:'Enviar lembretes e revisar posologia. Engajar via app.',
          politica:'fora_escopo=N√ÉO.'
        };
      },
      consulta_expirada(){
        return {
          titulo:'Consulta expirada',
          msg:'Sem retorno em 30 dias (sugest√£o de reagendamento).',
          sev:'info',
          acao:'Propor agenda de follow-up e fechamento de ciclo.',
          politica:'consulta_expirada=ATIVA.'
        };
      },
      fora_escopo(){
        return {
          titulo:'Fora de escopo ‚Äî triagem vermelha',
          msg:'Sintoma de alto risco (ex.: dor tor√°cica s√∫bita).',
          sev:'emer',
          acao:'Direcionar a servi√ßo de emerg√™ncia (192) imediatamente.',
          politica:'fora_escopo=SIM.'
        };
      }
    };

    // Disparo de alertas
    document.getElementById('btnDisparar').addEventListener('click', ()=>{
      const marcadas = Array.from(document.querySelectorAll('.regra:checked')).map(r=>r.value);
      if(!marcadas.length) return;
      marcadas.forEach(key=>pushAlert(key));
    });
    document.getElementById('btnExemplo').addEventListener('click', ()=>{
      ['dose_perdida','febre','pa_emerg'].forEach(k=>pushAlert(k));
    });

    function pushAlert(key){
      const r = regras[key] && regras[key]();
      if(!r) return;
      const canaisSel = Object.entries(canais()).filter(([_,v])=>v).map(([k])=>k.toUpperCase()).join(', ') || 'APP';
      const ts = new Date().toLocaleString('pt-BR');
      const cls = r.sev==='emer'?'sev-emer':(r.sev==='attn'?'sev-attn':'sev-info');

      const el = document.createElement('div');
      el.className = `alert ${cls}`;
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:start">
          <div>
            <strong>${r.titulo}</strong>
            <span class="tag">${r.sev.toUpperCase()}</span>
            <div class="meta">Perfil: ${perfil().toUpperCase()} ¬∑ Canais: ${canaisSel} ¬∑ ${ts}</div>
            <p style="margin:8px 0">${r.msg}</p>
            <p class="muted">A√ß√£o sugerida: ${r.acao}</p>
            <p class="muted">Pol√≠ticas (demo): ${r.politica}</p>
          </div>
          <div>
            <button class="btn-link" aria-label="Explicar alerta no Dr. AI" data-ai="${key}">Explicar com Dr. AI</button>
          </div>
        </div>
      `;
      // topo do feed
      feed.prepend(el);

      // wire do bot√£o AI
      const b = el.querySelector('[data-ai]');
      b.addEventListener('click', ()=>{
        const pergunta = buildQuestion(perfil(), r);
        try{ window.Telemetry?.event?.({event_name:'cta_click', meta:{name:'alerts_demo_explain_'+key}});}catch(e){}
        location.href = '/dr-ai.html?ctx=alertas&q='+encodeURIComponent(pergunta);
      });
    }

    function buildQuestion(perfilAtual, r){
      return [
        `Contexto: alertas. Perfil=${perfilAtual}.`,
        `Alerta: ${r.titulo} ‚Äî ${r.msg}`,
        `Pol√≠ticas: ${r.politica}`,
        `Explique o racional, priorize risco/gravidade, e recomende pr√≥ximos passos objetivos.`,
        `Se EMERG√äNCIA, reforce orienta√ß√£o 192/SAMU e sinais de alarme.`
      ].join(' ');
    }
  </script>
</body>
</html>
