<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador de Alertas (demo) â€” TeleMed</title>
  <link rel="stylesheet" href="/assets/css/base.css" />
  <style>
    .container{max-width:1080px;margin:36px auto;padding:16px}
    .subtitle{color:var(--muted);margin-bottom:16px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    fieldset{border:1px solid rgba(0,0,0,.08);background:#f8fafc;border-radius:12px;padding:16px}
    legend{font-weight:700;color:#1e293b;padding:0 8px}
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0}
    .feed{display:grid;gap:12px;min-height:200px}
    .alert{border-radius:12px;padding:14px;border:1px solid rgba(0,0,0,.08);background:#fff}
    .sev-info{border-left:6px solid #2563eb;background:#eff6ff}
    .sev-attn{border-left:6px solid #d97706;background:#fff8ed}
    .sev-emer{border-left:6px solid #b91c1c;background:#fff1f2}
    .meta{font-size:12px;color:var(--muted);margin:4px 0}
    .tag{background:#eef2ff;border:1px solid rgba(37,99,235,.2);border-radius:999px;padding:2px 10px;font-size:11px;margin-left:6px;font-weight:600}
    .btn-link{background:none;border:none;color:var(--accent);text-decoration:underline;cursor:pointer;font:inherit;padding:4px 0}
    .info-box{background:#eef2ff;border:1px solid rgba(37,99,235,.2);border-radius:12px;padding:12px;margin-bottom:16px}
    label{display:flex;align-items:center;gap:8px;cursor:pointer;padding:4px 0}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”” Simulador de Alertas (demo)</h1>
    <div class="subtitle">Dispare situaÃ§Ãµes clÃ­nicas comuns e veja o feed de alertas com <strong>severidade</strong>, <strong>aÃ§Ãµes sugeridas</strong> e integraÃ§Ã£o com o Dr. AI.</div>

    <div class="info-box">
      <strong>ğŸ’¡ Como funciona:</strong> Selecione o perfil (Paciente/MÃ©dico), marque as regras de alerta que deseja testar e clique em "Disparar selecionados". Os alertas aparecerÃ£o no feed Ã  direita com cores por severidade.
    </div>

    <div class="grid">
      <section>
        <fieldset>
          <legend>ğŸ‘¤ Perfil & Canal de NotificaÃ§Ã£o</legend>
          <div class="actions">
            <label data-testid="radio-paciente"><input type="radio" name="perfil" value="paciente" checked /> Paciente</label>
            <label data-testid="radio-medico"><input type="radio" name="perfil" value="medico" /> MÃ©dico</label>
          </div>
          <div class="actions">
            <label data-testid="checkbox-app"><input type="checkbox" id="canal_app" checked /> App (push)</label>
            <label data-testid="checkbox-email"><input type="checkbox" id="canal_email" /> Email</label>
            <label data-testid="checkbox-sms"><input type="checkbox" id="canal_sms" /> SMS</label>
          </div>
        </fieldset>

        <fieldset style="margin-top:12px">
          <legend>âš™ï¸ Regras ClÃ­nicas (demo)</legend>
          <div style="display:flex;flex-direction:column;gap:6px">
            <label data-testid="checkbox-febre"><input type="checkbox" class="regra" value="febre" /> ğŸŒ¡ï¸ Febre alta &gt; 38.5 Â°C</label>
            <label data-testid="checkbox-pa"><input type="checkbox" class="regra" value="pa_emerg" /> ğŸš¨ PA &gt;= 180/120 mmHg (emergÃªncia)</label>
            <label data-testid="checkbox-hipoglic"><input type="checkbox" class="regra" value="hipoglic" /> ğŸ©¸ Glicemia &lt; 60 mg/dL (hipoglicemia)</label>
            <label data-testid="checkbox-dose"><input type="checkbox" class="regra" value="dose_perdida" /> ğŸ’Š Esquecimento de dose</label>
            <label data-testid="checkbox-consulta"><input type="checkbox" class="regra" value="consulta_expirada" /> ğŸ“… Consulta expirada (sem retorno em 30 dias)</label>
            <label data-testid="checkbox-fora"><input type="checkbox" class="regra" value="fora_escopo" /> âš ï¸ Fora de escopo (ex.: dor torÃ¡cica sÃºbita)</label>
          </div>
          <div class="actions" style="margin-top:12px">
            <button class="btn" id="btnDisparar" data-cta="alerts_demo_trigger" data-testid="button-disparar">âš¡ Disparar selecionados</button>
            <button class="btn" id="btnExemplo" data-cta="alerts_demo_example" data-testid="button-exemplo">ğŸ“¥ Disparar exemplo</button>
            <a class="btn" href="/dashboard-piloto.html" data-cta="alerts_demo_dash" data-testid="button-telemetria">ğŸ“Š Ver telemetria</a>
          </div>
        </fieldset>
      </section>

      <section>
        <fieldset style="height:100%;min-height:400px">
          <legend>ğŸ“¬ Feed de Alertas</legend>
          <div id="feed" class="feed" aria-live="polite" aria-busy="false" data-testid="feed-alertas"></div>
        </fieldset>
      </section>
    </div>

    <p style="margin-top:14px"><a href="/public/mod-alertas.html" class="muted" data-testid="link-back">â† Voltar ao MÃ³dulo de Alertas</a></p>
  </div>

  <script>
    // Telemetria
    window.__BUILD='pilot-r1';
    try{ window.Telemetry?.event?.({event_name:'page_view', meta:{page:'/public/alertas-demo.html'}});}catch(e){}
    document.querySelectorAll('[data-cta]').forEach(el=>{
      el.addEventListener('click',()=>{ try{ window.Telemetry?.event?.({event_name:'cta_click', meta:{name:el.dataset.cta}});}catch(e){} });
    });

    const feed = document.getElementById('feed');
    const perfil = ()=> document.querySelector('input[name="perfil"]:checked').value;
    const canais = ()=>({
      app: document.getElementById('canal_app').checked,
      email: document.getElementById('canal_email').checked,
      sms: document.getElementById('canal_sms').checked,
    });

    const regras = {
      febre(){
        return {
          titulo:'Febre alta reportada',
          msg:'Temperatura > 38.5 Â°C nas Ãºltimas 24â€“48h.',
          sev:'attn',
          acao:'Orientar antitÃ©rmico, hidrataÃ§Ã£o e sinais de alerta. Avaliar agendamento.',
          politica:'escala_emergencia=NÃƒO (orientar sinais de alarme).'
        };
      },
      pa_emerg(){
        return {
          titulo:'PA crÃ­tica',
          msg:'PressÃ£o arterial â‰¥ 180/120 mmHg.',
          sev:'emer',
          acao:'Encaminhar para emergÃªncia imediatamente. Orientar procurar atendimento 192/SAMU.',
          politica:'escala_emergencia=SIM.'
        };
      },
      hipoglic(){
        return {
          titulo:'Hipoglicemia provÃ¡vel',
          msg:'Glicemia < 60 mg/dL.',
          sev:'emer',
          acao:'Regra dos 15g de glicose e reavaliaÃ§Ã£o; se piora ou rebaixamento, emergÃªncia.',
          politica:'escala_emergencia=DEPENDE (avaliar sintomas).'
        };
      },
      dose_perdida(){
        return {
          titulo:'PossÃ­vel baixa adesÃ£o',
          msg:'Paciente reportou esquecimento de doses.',
          sev:'info',
          acao:'Enviar lembretes e revisar posologia. Engajar via app.',
          politica:'fora_escopo=NÃƒO.'
        };
      },
      consulta_expirada(){
        return {
          titulo:'Consulta expirada',
          msg:'Paciente sem retorno em 30 dias. Risco de descontinuidade.',
          sev:'attn',
          acao:'Sugerir reagendamento via app ou telefone.',
          politica:'engajamento=MÃ‰DIO.'
        };
      },
      fora_escopo(){
        return {
          titulo:'Fora de escopo',
          msg:'Sintoma potencialmente grave (ex.: dor torÃ¡cica sÃºbita).',
          sev:'emer',
          acao:'Encaminhar imediatamente para emergÃªncia presencial.',
          politica:'fora_escopo=SIM.'
        };
      }
    };

    document.getElementById('btnDisparar').addEventListener('click', ()=>{
      const sel = Array.from(document.querySelectorAll('.regra:checked')).map(c=>c.value);
      if(!sel.length) return alert('Marque pelo menos uma regra.');
      sel.forEach(pushAlert);
    });

    document.getElementById('btnExemplo').addEventListener('click', ()=>{
      ['dose_perdida','febre','pa_emerg'].forEach(k=>pushAlert(k));
    });

    function pushAlert(key){
      const r = regras[key] && regras[key]();
      if(!r) return;
      const canaisSel = Object.entries(canais()).filter(([_,v])=>v).map(([k])=>k.toUpperCase()).join(', ') || 'APP';
      const ts = new Date().toLocaleString('pt-BR');
      const cls = r.sev==='emer'?'sev-emer':(r.sev==='attn'?'sev-attn':'sev-info');
      const sevLabel = r.sev==='emer'?'EMER':(r.sev==='attn'?'ATTN':'INFO');

      const el = document.createElement('div');
      el.className = `alert ${cls}`;
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:start">
          <div style="flex:1">
            <strong>${r.titulo}</strong>
            <span class="tag">${sevLabel}</span>
            <div class="meta">Perfil: ${perfil().toUpperCase()} Â· Canais: ${canaisSel} Â· ${ts}</div>
            <p style="margin:8px 0">${r.msg}</p>
            <p class="muted" style="font-size:13px">AÃ§Ã£o sugerida: ${r.acao}</p>
            <p class="muted" style="font-size:13px">PolÃ­ticas (demo): ${r.politica}</p>
          </div>
          <div>
            <button class="btn-link" aria-label="Explicar alerta no Dr. AI" data-ai="${key}">ğŸ¤– Explicar com Dr. AI</button>
          </div>
        </div>
      `;
      feed.prepend(el);

      const b = el.querySelector('[data-ai]');
      b.addEventListener('click', ()=>{
        const pergunta = buildQuestion(perfil(), r);
        try{ window.Telemetry?.event?.({event_name:'cta_click', meta:{name:'alerts_demo_explain_'+key}});}catch(e){}
        location.href = '/dr-ai.html?ctx=alertas&q='+encodeURIComponent(pergunta);
      });
    }

    function buildQuestion(perfilAtual, r){
      return [
        `Contexto: alertas. Perfil=${perfilAtual}.`,
        `Alerta: ${r.titulo} â€” ${r.msg}`,
        `PolÃ­ticas: ${r.politica}`,
        `Explique o racional, priorize risco/gravidade, e recomende prÃ³ximos passos objetivos.`,
        `Se EMERGÃŠNCIA, reforce orientaÃ§Ã£o 192/SAMU e sinais de alarme.`
      ].join(' ');
    }

    // Suporte a parÃ¢metros de URL para prÃ©-configurar perfil, regras e canais
    (function(){
      const p = new URLSearchParams(location.search);
      const pf = p.get('perfil');
      const rs = (p.get('rules')||'').split(',').filter(Boolean);
      const ch = (p.get('channels')||'app').split(',');
      if(pf){ const r = document.querySelector(`input[name="perfil"][value="${pf}"]`); r && (r.checked = true); }
      if(rs.length){ 
        rs.forEach(k=>{ 
          const cb = document.querySelector(`.regra[value="${k}"]`); 
          cb && (cb.checked=true); 
        }); 
      }
      ['app','email','sms'].forEach(k=>{
        const id = 'canal_'+k; const on = ch.includes(k);
        const el = document.getElementById(id); if(el) el.checked = on;
      });
    })();
  </script>
</body>
</html>
