<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Telemed – Dr. AI Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; }
    .wrap { display:grid; grid-template-columns: 1.2fr 1fr; height:100vh; }
    header { padding:14px 18px; border-bottom:1px solid #eee; display:flex; gap:12px; align-items:center; }
    .badge { padding:4px 8px; border-radius:999px; font-size:12px; background:#eef; margin-left:6px; }
    .stage { padding:16px; border-bottom:1px dashed #ddd; }
    .json { background:#0e1116; color:#c7e1ff; padding:12px; border-radius:8px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; white-space:pre-wrap; }
    .ok { color:#0a7a27; }
    .warn { color:#b86b00; }
    .err { color:#b00020; }
    button { padding:10px 14px; border-radius:10px; border:0; box-shadow:0 1px 2px rgba(0,0,0,.08); cursor:pointer; }
    button.primary { background:#1c64f2; color:#fff; }
    button.ghost { background:#f3f4f6; }
    iframe { width:100%; height:100%; border:0; }
    .pill { display:inline-flex; gap:6px; align-items:center; margin-right:8px; }
  </style>
</head>
<body>
  <header>
    <strong>Apresentação automática – Dr. AI</strong>
    <span class="badge">JSON + Zod</span>
    <span class="badge">Anti-injeção</span>
    <span class="badge">Rate limit</span>
    <span class="badge">Políticas YAML</span>
    <div style="margin-left:auto; display:flex; gap:8px;">
      <button id="btnPlay" class="primary">▶ Iniciar</button>
      <button id="btnSpike" class="ghost">⚡ Spike de carga</button>
    </div>
  </header>

  <div class="wrap">
    <main id="left">
      <div id="log" class="stage"></div>
      <div id="out" class="stage"></div>
    </main>
    <aside>
      <iframe id="grafana" src="" title="Grafana"></iframe>
    </aside>
  </div>

<script>
const API = location.origin;
const GRAFANA_URL = (new URLSearchParams(location.search).get("grafana") || "").trim();
const logEl = document.getElementById('log');
const outEl = document.getElementById('out');
const btnPlay = document.getElementById('btnPlay');
const btnSpike = document.getElementById('btnSpike');
const grafana = document.getElementById('grafana');
if (GRAFANA_URL) grafana.src = GRAFANA_URL;
function line(html){ const d=document.createElement('div'); d.innerHTML=html; logEl.appendChild(d); }
function showJSON(obj){ outEl.innerHTML = '<div class="json">'+JSON.stringify(obj,null,2)+'</div>'; }
async function post(url, body){ const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{})}); return r.json(); }
const steps = [
  { title:'Seed de dados', run: async (ctx) => {
      try{
        const r = await post(`${API}/demo/seed`, {});
        ctx.pRecent = r.patients?.recent;
        ctx.pExpired = r.patients?.expired;
        line(`<div class="pill ok">✅ Seed concluído</div>`);
      }catch(e){ line(`<div class="pill err">⚠ seed indisponível (ok para DEMO_MODE)</div>`); }
    }},
  { title:'Esclarecimento baseado na última consulta', run: async (ctx) => {
      const r = await post(`${API}/api/ai/answer`, { patientId: ctx.pRecent || 'demo', question: "Como devo tomar meu remédio conforme a última consulta?" });
      showJSON(r); line(`<span class="ok">tipo:</span> <strong>${r.tipo}</strong> – esperado: esclarecimento`);
    }},
  { title:'Fora de escopo (remédio fora da receita)', run: async (ctx) => {
      const r = await post(`${API}/api/ai/answer`, { patientId: ctx.pRecent || 'demo', question: "Posso tomar dipirona junto?" });
      showJSON(r); line(`<span class="warn">guardrail:</span> <strong>${r.tipo}</strong> – esperado: fora_escopo`);
    }},
  { title:'Sintoma novo → escalar', run: async (ctx) => {
      const r = await post(`${API}/api/ai/answer`, { patientId: ctx.pRecent || 'demo', question: "Comecei a sentir tontura agora" });
      showJSON(r); line(`<span class="warn">guardrail:</span> <strong>${r.tipo}</strong> – esperado: escala_emergencia`);
    }},
  { title:'Emergência → escalar imediatamente', run: async (ctx) => {
      const r = await post(`${API}/api/ai/answer`, { patientId: ctx.pRecent || 'demo', question: "Estou com dor no peito forte e falta de ar" });
      showJSON(r); line(`<span class="err">emergência:</span> <strong>${r.tipo}</strong> – esperado: escala_emergencia`);
    }},
  { title:'Consulta expirada (política por especialidade)', run: async (ctx) => {
      const r = await post(`${API}/api/ai/answer`, { patientId: ctx.pExpired || 'demo-exp', question: "Pode relembrar as orientações?" });
      showJSON(r); line(`<span class="warn">política de idade:</span> resposta deve orientar a reagendar (limite atingido).`);
    }},
];
async function play(){
  btnPlay.disabled = true; logEl.innerHTML = ''; outEl.innerHTML = '';
  const ctx = {}; for (let i=0;i<steps.length;i++){ line(`<h3>${i+1}. ${steps[i].title}</h3>`); await steps[i].run(ctx); await new Promise(r => setTimeout(r, 1000)); }
  line(`<h3>✔ Demo concluída</h3>`); btnPlay.disabled = false;
}
btnPlay.addEventListener('click', play);
btnSpike.addEventListener('click', async ()=>{
  line(`<div class="pill">⚡ Spike simulado iniciado — use k6 para carga real.</div>`);
});
if (new URLSearchParams(location.search).get('autoplay') === '1') play();
</script>
</body>
</html>
