<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Piloto - TeleMed</title>
  <style>
    :root {
      --bg: #0b1220; --card: #111a2b; --muted: #a5b4c3; --fg: #e6edf3;
      --ok: #17c964; --warn: #f5a524; --err: #f31260; --accent: #0072f5;
      --border: #21304b; --success: #39d98a;
    }
    body { margin: 0; font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--fg); }
    .header { background: var(--card); border-bottom: 1px solid var(--border); padding: 20px 0; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 24px; }
    h1 { margin: 0; color: var(--accent); }
    .subtitle { color: var(--muted); margin: 4px 0 0; }
    .main { padding: 24px 0; }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .metric-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
    .metric-title { font-size: 14px; color: var(--muted); margin-bottom: 8px; }
    .metric-value { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
    .metric-change { font-size: 14px; display: flex; align-items: center; gap: 4px; }
    .trend-up { color: var(--ok); }
    .trend-down { color: var(--err); }
    .trend-neutral { color: var(--muted); }
    .funnel-section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px; }
    .funnel-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border); }
    .funnel-item:last-child { border-bottom: none; }
    .funnel-stage { font-weight: 600; }
    .funnel-bar { flex: 1; margin: 0 16px; height: 20px; background: rgba(255,255,255,0.05); border-radius: 10px; position: relative; overflow: hidden; }
    .funnel-progress { height: 100%; border-radius: 10px; transition: width 0.3s ease; }
    .funnel-stats { text-align: right; min-width: 80px; font-size: 14px; }
    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
    @media (max-width: 768px) { .charts-grid { grid-template-columns: 1fr; } }
    .chart-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
    .chart-placeholder { height: 200px; background: rgba(255,255,255,0.02); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--muted); }
    .logs-section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
    .log-item { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-family: 'Courier New', monospace; font-size: 13px; }
    .log-item:last-child { border-bottom: none; }
    .log-timestamp { color: var(--muted); }
    .log-level { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; }
    .log-info { background: rgba(23, 201, 100, 0.1); color: var(--ok); }
    .log-warn { background: rgba(245, 165, 36, 0.1); color: var(--warn); }
    .log-error { background: rgba(243, 18, 96, 0.1); color: var(--err); }
    .actions { display: flex; gap: 12px; margin: 24px 0; flex-wrap: wrap; }
    .btn { background: var(--accent); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--fg); }
    .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .refreshing { opacity: 0.7; pointer-events: none; }
    .last-updated { text-align: center; color: var(--muted); font-size: 14px; padding: 16px 0; }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <h1>üìä Dashboard Piloto TeleMed</h1>
      <p class="subtitle">M√©tricas em tempo real ¬∑ Set-Out 2025</p>
    </div>
  </div>

  <div class="main">
    <div class="container">
      <!-- KPIs principais -->
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-title">Usu√°rios Totais</div>
          <div class="metric-value" id="total-users">--</div>
          <div class="metric-change trend-up">
            <span>‚Üó</span> +12 esta semana
          </div>
        </div>
        
        <div class="metric-card">
          <div class="metric-title">Consultas Realizadas</div>
          <div class="metric-value" id="consultations">--</div>
          <div class="metric-change trend-up">
            <span>‚Üó</span> +8 √∫ltimas 24h
          </div>
        </div>
        
        <div class="metric-card">
          <div class="metric-title">NPS M√©dio</div>
          <div class="metric-value" id="nps-score">--</div>
          <div class="metric-change trend-neutral">
            <span>‚Üí</span> Est√°vel
          </div>
        </div>
        
        <div class="metric-card">
          <div class="metric-title">Disponibilidade</div>
          <div class="metric-value" id="uptime">--</div>
          <div class="metric-change trend-up">
            <span class="status-indicator" style="background: var(--ok)"></span> Operacional
          </div>
        </div>
      </div>

      <!-- Funil de convers√£o -->
      <div class="funnel-section">
        <h2 style="margin: 0 0 20px; color: var(--accent)">Funil de Convers√£o</h2>
        
        <div class="funnel-item">
          <div class="funnel-stage">1. Convite/Landing</div>
          <div class="funnel-bar">
            <div class="funnel-progress" style="width: 100%; background: var(--ok)"></div>
          </div>
          <div class="funnel-stats">
            <div style="font-weight: 600;">150</div>
            <div style="color: var(--muted);">100%</div>
          </div>
        </div>
        
        <div class="funnel-item">
          <div class="funnel-stage">2. Cadastro</div>
          <div class="funnel-bar">
            <div class="funnel-progress" style="width: 68%; background: var(--accent)"></div>
          </div>
          <div class="funnel-stats">
            <div style="font-weight: 600;">102</div>
            <div style="color: var(--muted);">68%</div>
          </div>
        </div>
        
        <div class="funnel-item">
          <div class="funnel-stage">3. Primeiro Pedido</div>
          <div class="funnel-bar">
            <div class="funnel-progress" style="width: 45%; background: var(--warn)"></div>
          </div>
          <div class="funnel-stats">
            <div style="font-weight: 600;">68</div>
            <div style="color: var(--muted);">45%</div>
          </div>
        </div>
        
        <div class="funnel-item">
          <div class="funnel-stage">4. Consulta Iniciada</div>
          <div class="funnel-bar">
            <div class="funnel-progress" style="width: 38%; background: var(--success)"></div>
          </div>
          <div class="funnel-stats">
            <div style="font-weight: 600;">57</div>
            <div style="color: var(--muted);">38%</div>
          </div>
        </div>
        
        <div class="funnel-item">
          <div class="funnel-stage">5. Feedback Enviado</div>
          <div class="funnel-bar">
            <div class="funnel-progress" style="width: 28%; background: var(--accent)"></div>
          </div>
          <div class="funnel-stats">
            <div style="font-weight: 600;">42</div>
            <div style="color: var(--muted);">28%</div>
          </div>
        </div>
      </div>

      <!-- Gr√°ficos -->
      <div class="charts-grid">
        <div class="chart-card">
          <h3 style="margin: 0 0 16px; color: var(--accent)">Cadastros por Dia</h3>
          <div class="chart-placeholder" id="signup-chart">
            üìà Gr√°fico de cadastros di√°rios
            <br><small>(Integra√ß√£o com biblioteca de gr√°ficos)</small>
          </div>
        </div>
        
        <div class="chart-card">
          <h3 style="margin: 0 0 16px; color: var(--accent)">Qualidade das Chamadas</h3>
          <div class="chart-placeholder" id="call-quality-chart">
            üìä Qualidade de conex√£o
            <br><small>(Lat√™ncia, reconex√µes, drops)</small>
          </div>
        </div>
      </div>

      <!-- Logs recentes -->
      <div class="logs-section">
        <h3 style="margin: 0 0 16px; color: var(--accent)">Logs Recentes</h3>
        <div id="logs-container">
          <!-- Carregado via JS -->
        </div>
      </div>

      <!-- A√ß√µes -->
      <div class="actions">
        <button class="btn" onclick="refreshDashboard()" id="refresh-btn">üîÑ Atualizar</button>
        <button class="btn btn-secondary" onclick="exportMetrics()">üìä Exportar CSV</button>
        <button class="btn btn-secondary" onclick="window.open('/status.html', '_blank')">üîç Status Page</button>
        <button class="btn btn-secondary" onclick="window.open('/admin-flags.html', '_blank')">üèÅ Feature Flags</button>
      </div>

      <div class="last-updated">
        √öltima atualiza√ß√£o: <span id="last-update">--</span>
      </div>
    </div>
  </div>

  <script src="/js/feature-flags.js"></script>
  <script src="/js/audit-logger.js"></script>
  <script>
    // Dados simulados para o dashboard
    const mockData = {
      totalUsers: () => Math.floor(85 + Math.random() * 20),
      consultations: () => Math.floor(42 + Math.random() * 15),
      npsScore: () => (7.8 + Math.random() * 1.5).toFixed(1),
      uptime: () => (99.1 + Math.random() * 0.8).toFixed(1) + '%'
    };

    // Simular logs de auditoria
    function generateMockLogs() {
      const events = [
        'user_registered', 'consultation_started', 'ai_suggestion_shown', 
        'payment_processed', 'feedback_submitted', 'system_health_check'
      ];
      
      const levels = ['INFO', 'WARN', 'ERROR'];
      const logs = [];
      
      for (let i = 0; i < 10; i++) {
        const timestamp = new Date(Date.now() - Math.random() * 3600000).toLocaleString('pt-BR');
        const level = levels[Math.floor(Math.random() * levels.length)];
        const event = events[Math.floor(Math.random() * events.length)];
        
        logs.push({
          timestamp,
          level,
          event,
          trace_id: 'trc_' + Math.random().toString(36).substr(2, 9)
        });
      }
      
      return logs;
    }

    // Renderizar logs
    function renderLogs() {
      const container = document.getElementById('logs-container');
      const logs = generateMockLogs();
      
      container.innerHTML = logs.map(log => `
        <div class="log-item">
          <span class="log-timestamp">[${log.timestamp}]</span>
          <span class="log-level log-${log.level.toLowerCase()}">${log.level}</span>
          <span>${log.event}</span>
          <span style="color: var(--muted); margin-left: 12px;">${log.trace_id}</span>
        </div>
      `).join('');
    }

    // Atualizar m√©tricas
    function updateMetrics() {
      document.getElementById('total-users').textContent = mockData.totalUsers();
      document.getElementById('consultations').textContent = mockData.consultations();
      document.getElementById('nps-score').textContent = mockData.npsScore();
      document.getElementById('uptime').textContent = mockData.uptime();
    }

    // Atualizar dashboard completo
    function refreshDashboard() {
      const btn = document.getElementById('refresh-btn');
      const container = document.querySelector('.container');
      
      btn.disabled = true;
      btn.textContent = 'üîÑ Atualizando...';
      container.classList.add('refreshing');
      
      setTimeout(() => {
        updateMetrics();
        renderLogs();
        document.getElementById('last-update').textContent = new Date().toLocaleString('pt-BR');
        
        btn.disabled = false;
        btn.textContent = 'üîÑ Atualizar';
        container.classList.remove('refreshing');
        
        // Log da a√ß√£o
        AuditLogger.log('dashboard_refreshed', {
          timestamp: new Date().toISOString()
        });
      }, 1000);
    }

    // Exportar m√©tricas
    function exportMetrics() {
      const data = {
        timestamp: new Date().toISOString(),
        metrics: {
          total_users: document.getElementById('total-users').textContent,
          consultations: document.getElementById('consultations').textContent,
          nps_score: document.getElementById('nps-score').textContent,
          uptime: document.getElementById('uptime').textContent
        },
        funnel: [
          { stage: 'landing', count: 150, conversion: 100 },
          { stage: 'signup', count: 102, conversion: 68 },
          { stage: 'first_request', count: 68, conversion: 45 },
          { stage: 'consultation_started', count: 57, conversion: 38 },
          { stage: 'feedback_submitted', count: 42, conversion: 28 }
        ]
      };
      
      const csv = convertToCSV(data);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `telemed_metrics_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      
      URL.revokeObjectURL(url);
      
      AuditLogger.log('metrics_exported', {
        format: 'csv',
        records: data.funnel.length + 1
      });
    }

    // Converter dados para CSV
    function convertToCSV(data) {
      const headers = ['metric', 'value', 'timestamp'];
      const rows = [headers.join(',')];
      
      Object.entries(data.metrics).forEach(([key, value]) => {
        rows.push(`"${key}","${value}","${data.timestamp}"`);
      });
      
      data.funnel.forEach(item => {
        rows.push(`"funnel_${item.stage}","${item.count}","${data.timestamp}"`);
      });
      
      return rows.join('\n');
    }

    // Verificar se usu√°rio tem permiss√£o para ver dashboard
    function checkAccess() {
      // Em produ√ß√£o, verificaria autentica√ß√£o/autoriza√ß√£o real
      const consent = localStorage.getItem('telemed_consent');
      if (!consent) {
        alert('Dashboard restrito. Aceite os termos primeiro.');
        window.location.href = '/termos-privacidade.html?return=' + encodeURIComponent(location.href);
        return false;
      }
      return true;
    }

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
      if (!checkAccess()) return;
      
      // Carregar dados iniciais
      updateMetrics();
      renderLogs();
      document.getElementById('last-update').textContent = new Date().toLocaleString('pt-BR');
      
      // Auto-refresh a cada 30 segundos
      setInterval(() => {
        if (!document.hidden) {
          updateMetrics();
        }
      }, 30000);
      
      // Log de visualiza√ß√£o do dashboard
      AuditLogger.log('dashboard_viewed', {
        referrer: document.referrer,
        user_agent: navigator.userAgent.substring(0, 100)
      });
    });
  </script>
</body>
</html>