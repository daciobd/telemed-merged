<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <base href="/">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Consulta ‚Ä¢ TeleMed</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect rx='12' width='64' height='64' fill='%231e40af'/%3E%3Ctext x='32' y='42' font-family='Inter,Arial' font-size='36' text-anchor='middle' fill='white'%3ETM%3C/text%3E%3C/svg%3E" />
  
  <!-- Tailwind CSS -->
  <link rel="stylesheet" crossorigin href="/assets/index-BixFYIh2.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    
    /* Loading skeleton */
    .loading-skeleton {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
  </style>
</head>
<body>
  <div id="consulta-root">
    <!-- Loading skeleton while React loads -->
    <div class="min-h-screen bg-gray-100">
      <div class="bg-blue-600 text-white">
        <div class="mx-auto max-w-7xl px-6 py-3">
          <div class="loading-skeleton h-8 bg-blue-700 rounded w-32"></div>
        </div>
      </div>
      <div class="mx-auto max-w-7xl px-4 py-4">
        <div class="grid grid-cols-1 gap-4 lg:grid-cols-12">
          <div class="lg:col-span-5 loading-skeleton h-64 bg-black rounded-xl"></div>
          <div class="lg:col-span-7 loading-skeleton h-96 bg-white rounded-xl shadow-md"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- React e depend√™ncias -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel standalone para compilar JSX no browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Componente React inline -->
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    
    // Utilidades simples
    const uid = (p) => `${p}_${Math.random().toString(36).slice(2, 8)}`;

    class AutoSave {
      constructor(key) {
        this.key = key;
        this.timer = null;
      }
      
      save(payload) {
        localStorage.setItem(this.key, JSON.stringify(payload));
      }
      
      load() {
        try {
          return JSON.parse(localStorage.getItem(this.key) || "{}");
        } catch {
          return {};
        }
      }
      
      start(fn, interval = 10000) {
        this.stop();
        this.timer = setInterval(() => this.save(fn()), interval);
      }
      
      stop() {
        if (this.timer) clearInterval(this.timer);
      }
    }

    const CID_SUGESTOES = [
      "F41.1 Ansiedade",
      "F32 Depress√£o",
      "J00 Resfriado",
      "I10 HAS",
      "E11 DM2",
      "Z76 Acompanhamento",
    ];

    function ConsultaDoc24() {
      const sp = new URLSearchParams(window.location.search);
      const patientId = sp.get("patientId") || "3335602";
      const sexo = sp.get("sexo") || "F";
      const idade = Number(sp.get("idade") || 36);

      // Registro com autosave
      const storageKey = `reg_consulta_${patientId}`;
      const autosave = useRef(new AutoSave(storageKey));
      const [reg, setReg] = useState(() => ({
        queixa: "",
        doencaAtual: "",
        hipoteses: [],
        conduta: "",
        notasPrivadas: "",
        exames: "",
        prescricoes: "",
        encaminhamento: "",
        arquivos: [],
        contato: "",
      }));

      // Load saved data on mount
      useEffect(() => {
        const draft = autosave.current.load();
        if (Object.keys(draft).length > 0) {
          setReg((r) => ({ ...r, ...draft }));
        }
      }, []);

      // Save data whenever reg changes
      useEffect(() => {
        autosave.current.save(reg);
      }, [reg]);

      // Auto-save timer
      useEffect(() => {
        const timer = setInterval(() => {
          autosave.current.save(reg);
        }, 10000);
        return () => clearInterval(timer);
      }, [reg]);

      const addHipotese = (h) =>
        setReg((r) => ({ ...r, hipoteses: Array.from(new Set([...r.hipoteses, h])) }));
      const rmHipotese = (h) =>
        setReg((r) => ({ ...r, hipoteses: r.hipoteses.filter((x) => x !== h) }));

      const abrirDiretrizes = () => {
        const url = `/dr-ai?queixa=${encodeURIComponent(reg.queixa)}&idade=${idade}&sexo=${sexo}`;
        window.open(url, "_blank");
      };

      const finalizar = () => {
        // aqui voc√™ pode chamar o backend e depois‚Ä¶
        window.location.href = `/pos-consulta-feedback.html?patientId=${patientId}`;
      };

      return (
        <div className="min-h-screen bg-gray-100">
          {/* Topbar */}
          <header className="w-full bg-blue-600 text-white">
            <div className="mx-auto max-w-7xl px-6 py-3 flex items-center justify-between">
              <div className="text-xl font-bold" data-testid="logo-doc24">doc24</div>
              <div className="text-sm" data-testid="paciente-id">Paciente #{patientId}</div>
            </div>
          </header>

          <main className="mx-auto max-w-7xl px-4 py-4">
            <div className="grid grid-cols-1 gap-4 lg:grid-cols-12">
              {/* V√≠deo */}
              <section className="lg:col-span-5 rounded-xl bg-black/90 text-white shadow-md aspect-video flex items-center justify-center" data-testid="video-container">
                {/* Substitua pelo seu componente WebRTC */}
                <div className="text-center">
                  <div className="mb-2 text-sm opacity-80">Pr√©-visualiza√ß√£o de v√≠deo</div>
                  <div className="text-3xl font-semibold">üé•</div>
                  <div className="mt-2 text-xs opacity-70">Use seu m√≥dulo de chamada aqui</div>
                </div>
              </section>

              {/* Registro Profissional */}
              <section className="lg:col-span-7 rounded-xl bg-white shadow-md">
                <div className="flex items-center justify-between border-b px-4 py-3">
                  <div className="text-base font-semibold" data-testid="titulo-registro">Registro Profissional</div>
                  <div className="flex items-center gap-2">
                    <button
                      onClick={abrirDiretrizes}
                      className="rounded-md border border-sky-500 px-3 py-1.5 text-sky-600 hover:bg-sky-50"
                      data-testid="botao-diretrizes">
                      Diretrizes de Cuidados
                    </button>
                    <button className="rounded-md bg-rose-600 px-3 py-1.5 text-white" data-testid="botao-emergencia">
                      Marcar como emerg√™ncia
                    </button>
                  </div>
                </div>

                <div className="grid grid-cols-1 gap-3 p-4">
                  <div>
                    <label className="mb-1 block text-sm font-medium" data-testid="label-queixa">Queixa Principal *</label>
                    <textarea
                      value={reg.queixa}
                      onChange={(e) => setReg((r) => ({ ...r, queixa: e.target.value }))}
                      className="min-h-[64px] w-full rounded-md border border-slate-300 px-3 py-2 outline-none focus:border-sky-500"
                      data-testid="textarea-queixa"
                    />
                  </div>
                  <div>
                    <label className="mb-1 block text-sm font-medium" data-testid="label-doenca-atual">Doen√ßa atual *</label>
                    <textarea
                      value={reg.doencaAtual}
                      onChange={(e) => setReg((r) => ({ ...r, doencaAtual: e.target.value }))}
                      className="min-h-[96px] w-full rounded-md border border-slate-300 px-3 py-2 outline-none focus:border-sky-500"
                      data-testid="textarea-doenca-atual"
                    />
                  </div>

                  {/* Hip√≥teses com chips */}
                  <div>
                    <label className="mb-1 block text-sm font-medium" data-testid="label-hipoteses">Hip√≥tese Diagn√≥stica *</label>
                    <div className="flex flex-wrap gap-2" data-testid="chips-hipoteses">
                      {reg.hipoteses.map((h) => (
                        <span
                          key={h}
                          className="inline-flex items-center gap-1 rounded-full bg-sky-100 px-3 py-1 text-xs text-sky-700"
                          data-testid={`chip-hipotese-${h.replace(/\s+/g, '-').toLowerCase()}`}>
                          {h}
                          <button onClick={() => rmHipotese(h)} className="ml-1 text-sky-700" data-testid={`remove-hipotese-${h.replace(/\s+/g, '-').toLowerCase()}`}>
                            √ó
                          </button>
                        </span>
                      ))}
                    </div>
                    <div className="mt-2 flex flex-wrap gap-2" data-testid="sugestoes-cid">
                      {CID_SUGESTOES.map((s) => (
                        <button
                          key={s}
                          onClick={() => addHipotese(s)}
                          className="rounded-full border border-slate-300 px-3 py-1 text-xs hover:bg-slate-50"
                          data-testid={`sugestao-${s.replace(/\s+/g, '-').toLowerCase()}`}>
                          {s}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Abas simples */}
                  <Tabs
                    tabs={[
                      {
                        id: "conduta",
                        label: "Conduta Terap√™utica",
                        content: (
                          <textarea
                            value={reg.conduta}
                            onChange={(e) => setReg((r) => ({ ...r, conduta: e.target.value }))}
                            className="min-h-[120px] w-full rounded-md border border-slate-300 px-3 py-2 outline-none focus:border-sky-500"
                            data-testid="textarea-conduta"
                          />
                        ),
                      },
                      {
                        id: "notas",
                        label: "Notas privadas",
                        content: (
                          <div>
                            <div className="mb-2 text-xs text-slate-500">
                              R√≥tulo: <b>n√£o compartilhado</b>
                            </div>
                            <textarea
                              value={reg.notasPrivadas}
                              onChange={(e) =>
                                setReg((r) => ({ ...r, notasPrivadas: e.target.value }))
                              }
                              className="min-h-[100px] w-full rounded-md border border-slate-300 px-3 py-2 outline-none focus:border-sky-500"
                              data-testid="textarea-notas-privadas"
                            />
                          </div>
                        ),
                      },
                      {
                        id: "exames",
                        label: "Exames",
                        content: (
                          <textarea
                            value={reg.exames}
                            onChange={(e) => setReg((r) => ({ ...r, exames: e.target.value }))}
                            className="min-h-[100px] w-full rounded-md border border-slate-300 px-3 py-2 outline-none focus:border-sky-500"
                            data-testid="textarea-exames"
                          />
                        ),
                      },
                      {
                        id: "presc",
                        label: "Prescri√ß√µes",
                        content: (
                          <textarea
                            value={reg.prescricoes}
                            onChange={(e) => setReg((r) => ({ ...r, prescricoes: e.target.value }))}
                            className="min-h-[100px] w-full rounded-md border border-slate-300 px-3 py-2 outline-none focus:border-sky-500"
                            data-testid="textarea-prescricoes"
                          />
                        ),
                      },
                      {
                        id: "enc",
                        label: "Encaminhamento",
                        content: (
                          <textarea
                            value={reg.encaminhamento}
                            onChange={(e) =>
                              setReg((r) => ({ ...r, encaminhamento: e.target.value }))
                            }
                            className="min-h-[100px] w-full rounded-md border border-slate-300 px-3 py-2 outline-none focus:border-sky-500"
                            data-testid="textarea-encaminhamento"
                          />
                        ),
                      },
                      {
                        id: "arquivos",
                        label: "Arquivos",
                        content: (
                          <UploadBox
                            arquivos={reg.arquivos}
                            onAdd={(f) => setReg((r) => ({ ...r, arquivos: [...r.arquivos, f] }))}
                          />
                        ),
                      },
                      {
                        id: "contato",
                        label: "Contato",
                        content: (
                          <textarea
                            value={reg.contato}
                            onChange={(e) => setReg((r) => ({ ...r, contato: e.target.value }))}
                            className="min-h-[100px] w-full rounded-md border border-slate-300 px-3 py-2 outline-none focus:border-sky-500"
                            data-testid="textarea-contato"
                          />
                        ),
                      },
                    ]}
                  />

                  {/* A√ß√µes */}
                  <div className="mt-2 flex items-center justify-end gap-2">
                    <a href={`/phr-react.html?id=${patientId}`} className="rounded-md border px-4 py-2" data-testid="botao-ver-phr">
                      Ver PHR
                    </a>
                    <a href="/meus-pacientes-react.html" className="rounded-md border px-4 py-2" data-testid="botao-voltar">
                      Voltar
                    </a>
                    <button onClick={finalizar} className="rounded-md bg-rose-600 px-4 py-2 text-white" data-testid="botao-finalizar">
                      Finalizar atendimento
                    </button>
                  </div>
                </div>
              </section>
            </div>

            <div className="mt-4 text-xs text-slate-500" data-testid="atalhos-teclado">
              Atalhos: <kbd className="rounded border px-1">Ctrl</kbd>+
              <kbd className="rounded border px-1">Enter</kbd> para adicionar hip√≥tese;{" "}
              <kbd className="rounded border px-1">Alt</kbd>+
              <kbd className="rounded border px-1">D</kbd> abre Diretrizes.
            </div>
          </main>
        </div>
      );
    }

    // ----------------- Componentes auxiliares -----------------

    function Tabs({ tabs }) {
      const [active, setActive] = useState(tabs[0]?.id);
      const current = useMemo(() => tabs.find((t) => t.id === active), [active, tabs]);
      return (
        <div className="mt-2">
          <div className="flex flex-wrap gap-2 border-b pb-2 text-sm" data-testid="tabs-header">
            {tabs.map((t) => (
              <button
                key={t.id}
                onClick={() => setActive(t.id)}
                className={`rounded-md px-3 py-1 ${
                  active === t.id
                    ? "bg-sky-100 text-sky-700 border border-sky-300"
                    : "border border-slate-300 text-slate-700 hover:bg-slate-50"
                }`}
                data-testid={`tab-${t.id}`}>
                {t.label}
              </button>
            ))}
          </div>
          <div className="pt-3" data-testid="tab-content">
            {current?.content}
          </div>
        </div>
      );
    }

    function UploadBox({ arquivos, onAdd }) {
      const ref = useRef(null);
      const selectFile = () => ref.current?.click();
      const onFile = (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        onAdd(f.name);
      };
      return (
        <div className="rounded-lg border border-dashed p-6 text-center" data-testid="upload-box">
          <div className="text-sm">
            Arraste e solte um arquivo aqui ou{" "}
            <button onClick={selectFile} className="text-sky-600 underline" data-testid="botao-selecionar-arquivo">
              selecione
            </button>
          </div>
          <input ref={ref} type="file" className="hidden" onChange={onFile} data-testid="input-arquivo" />
          <ul className="mt-3 list-inside list-disc text-left text-sm" data-testid="lista-arquivos">
            {arquivos.map((a) => (
              <li key={a} data-testid={`arquivo-${a}`}>{a}</li>
            ))}
          </ul>
        </div>
      );
    }

    // Renderizar o componente
    ReactDOM.render(<ConsultaDoc24 />, document.getElementById('consulta-root'));
    
    console.log('‚úÖ Componente Consulta Doc24 carregado com sucesso!');
  </script>
</body>
</html>